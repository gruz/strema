name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          
          # Determine if this is a pre-release (beta)
          if [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since previous tag
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file in /tmp
          cat > /tmp/CHANGELOG.txt << EOF
          ## What's Changed
          
          $CHANGELOG
          
          **Full Changelog**: https://github.com/gruz/strema/compare/${PREV_TAG}...${{ steps.version.outputs.tag }}
          EOF
          
          echo "Generated changelog for version ${{ steps.version.outputs.version }}"
      
      - name: Create release archive
        run: |
          # Create VERSION file in the repo
          echo "${{ steps.version.outputs.version }}" > VERSION
          
          # Create archive
          tar -czf /tmp/strema-${{ steps.version.outputs.tag }}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='logs/*.log' \
            --exclude='logs/*.log.old' \
            --exclude='config/stream.conf' \
            --transform 's,^,strema/,' \
            .
          
          # Move archive to workspace
          mv /tmp/strema-${{ steps.version.outputs.tag }}.tar.gz .
          
          echo "Created archive: strema-${{ steps.version.outputs.tag }}.tar.gz"
          ls -lh strema-${{ steps.version.outputs.tag }}.tar.gz
      
      - name: Generate checksums
        run: |
          sha256sum strema-${{ steps.version.outputs.tag }}.tar.gz > checksums.txt
          cat checksums.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            strema-${{ steps.version.outputs.tag }}.tar.gz
            checksums.txt
          body_path: /tmp/CHANGELOG.txt
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
