<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORPOST Stream - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .cpu-mode-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
            margin-left: 8px;
        }

        .cpu-normal {
            background: #d1ecf1;
            color: #0c5460;
        }

        .cpu-high {
            background: #fff3cd;
            color: #856404;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group .help-text {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.show {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .update-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .update-overlay.show {
            display: flex;
        }

        .update-overlay .spinner {
            border-color: #f3f3f3;
            border-top-color: #667eea;
            width: 60px;
            height: 60px;
            border-width: 6px;
        }

        .update-overlay .message {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="updateOverlay" class="update-overlay">
        <div class="spinner"></div>
        <div class="message" id="updateMessage">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üé• FORPOST Stream</h1>
            <p>–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤—ñ–¥–µ–æ–ø–æ—Ç–æ–∫—É <span style="color: #999; font-size: 12px;">v{{ version }}</span></p>
            <div>
                <span id="statusBadge"></span>
                <span id="operationBadge" class="status-badge status-pending" style="display:none;"></span>
                <span id="cpuModeBadge" class="cpu-mode-badge"></span>
            </div>
        </div>

        <div id="alertBox" class="alert"></div>

        <div class="card" id="updateCard" style="display: none;">
            <div class="section-title" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleUpdateSection()">
                <span>üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ <span style="font-size: 12px; color: #999;">(–≤–µ—Ä—Å—ñ—è: <span id="currentVersionBadge">...</span>)</span></span>
                <span id="updateToggleIcon" style="font-size: 20px;">‚ñº</span>
            </div>
            
            <div id="updateContent" style="display: none; margin-top: 12px;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <strong>–ü–æ—Ç–æ—á–Ω–∞ –≤–µ—Ä—Å—ñ—è:</strong> <span id="currentVersion">...</span>
                        </div>
                        <div>
                            <label style="font-weight: normal; margin: 0;">
                                –ö–∞–Ω–∞–ª:
                                <select id="updateChannel" style="width: auto; padding: 4px 8px; margin-left: 8px;">
                                    <option value="stable">Stable</option>
                                    <option value="beta">Beta</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div id="updateAvailable" style="display: none; background: #d4edda; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <strong style="color: #155724;">‚ú® –î–æ—Å—Ç—É–ø–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <span id="latestVersion"></span></strong>
                    </div>
                    
                    <div id="updatesList"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—ñ–º—ñ–Ω–≥–æ–º</div>
            
            <div class="button-group">
                <button type="button" class="btn btn-primary" id="startBtn">
                    ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç—Ä—ñ–º
                </button>
                <button type="button" class="btn btn-secondary" id="stopBtn">
                    ‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ —Å—Ç—Ä—ñ–º
                </button>
                <button type="button" class="btn btn-secondary" id="restartStreamBtn">
                    üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç—Ä—ñ–º
                </button>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="autostartCheckbox" style="width: auto; margin-right: 8px;">
                    –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å—Ç—Ä—ñ–º—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å–∏—Å—Ç–µ–º–∏
                </label>
                <span class="help-text">–Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ, —Ç–æ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è —É –í–µ–∂—É —Å—Ç–∞—Ä—Ç—É—î –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω—ñ –î–∑–∏–≥–∏. –Ü–Ω–∞–∫—à–µ —ó—ó —Ç—Ä–µ–±–∞ –≤—Ä—É—á–Ω—É –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —á–µ—Ä–µ–∑ —Ü–µ–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.</span>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="autorestartCheckbox" style="width: auto; margin-right: 8px;">
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó
                </label>
                <span class="help-text">–î–æ–∑–≤–æ–ª—è—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑–±–∏–≤–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é —É –í–µ–∂—ñ –Ω–∞ –±–ª–æ–∫–∏</span>
            </div>

            <div class="form-group" id="autorestartIntervalGroup" style="display: none;">
                <label for="autorestartInterval">–ü–µ—Ä—ñ–æ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É (–≥–æ–¥–∏–Ω–∏)</label>
                <input type="number" id="autorestartInterval" min="1" max="24" value="2" style="width: 100px;">
            </div>
        </div>

        <div class="card">
            <form id="configForm">
                <div class="section-title">–û—Å–Ω–æ–≤–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>

                <div class="form-group">
                    <label for="RTMP_URL">RTMP URL</label>
                    <span class="help-text">–ü–æ–≤–Ω–∏–π URL –¥–ª—è —Å—Ç—Ä—ñ–º—É (–Ω–∞–ø—Ä. rtmps://server:port/app/key)</span>
                    <input type="text" id="RTMP_URL" name="RTMP_URL" required>
                </div>

                <div class="section-title">–û–≤–µ—Ä–ª–µ–π</div>

                <div class="form-group">
                    <label for="OVERLAY_TEXT">–¢–µ–∫—Å—Ç –æ–≤–µ—Ä–ª–µ—é ‚ö†Ô∏è</label>
                    <span class="help-text">–ó–∞–ª–∏—à—Ç–µ –ø—É—Å—Ç–∏–º —â–æ–± –≤–∏–º–∫–Ω—É—Ç–∏ –æ–≤–µ—Ä–ª–µ–π</span>
                    <span class="help-text" style="color: #d9534f; font-weight: 600;">‚ö†Ô∏è –£–í–ê–ì–ê: –û–≤–µ—Ä–ª–µ–π —Å—É—Ç—Ç—î–≤–æ –∑–±—ñ–ª—å—à—É—î –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ CPU! –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –æ–±–µ—Ä–µ–∂–Ω–æ.</span>
                    <input type="text" id="OVERLAY_TEXT" name="OVERLAY_TEXT">
                </div>

                <div class="form-group">
                    <label for="OVERLAY_POSITION">–ü–æ–∑–∏—Ü—ñ—è –æ–≤–µ—Ä–ª–µ—é</label>
                    <select id="OVERLAY_POSITION" name="OVERLAY_POSITION">
                        <option value="top-left">–ó–≤–µ—Ä—Ö—É –∑–ª—ñ–≤–∞</option>
                        <option value="top-right">–ó–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞</option>
                        <option value="bottom-left">–ó–Ω–∏–∑—É –∑–ª—ñ–≤–∞</option>
                        <option value="bottom-right">–ó–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="SHOW_FREQUENCY">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —á–∞—Å—Ç–æ—Ç—É ‚ö†Ô∏è</label>
                    <span class="help-text" style="color: #d9534f; font-weight: 600;">‚ö†Ô∏è –£–í–ê–ì–ê: –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–∞—Å—Ç–æ—Ç–∏ —Å—É—Ç—Ç—î–≤–æ –∑–±—ñ–ª—å—à—É—î –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ CPU! –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –æ–±–µ—Ä–µ–∂–Ω–æ.</span>
                    <select id="SHOW_FREQUENCY" name="SHOW_FREQUENCY">
                        <option value="true">–¢–∞–∫</option>
                        <option value="false">–ù—ñ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="FREQUENCY_POSITION">–ü–æ–∑–∏—Ü—ñ—è —á–∞—Å—Ç–æ—Ç–∏</label>
                    <select id="FREQUENCY_POSITION" name="FREQUENCY_POSITION">
                        <option value="top-left">–ó–≤–µ—Ä—Ö—É –∑–ª—ñ–≤–∞</option>
                        <option value="top-right">–ó–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞</option>
                        <option value="bottom-left">–ó–Ω–∏–∑—É –∑–ª—ñ–≤–∞</option>
                        <option value="bottom-right">–ó–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="STREAM_MODE">–†–µ–∂–∏–º —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó –ø—Ä–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ</label>
                    <span class="help-text">–í–∏–∑–Ω–∞—á–∞—î –ø–æ–≤–µ–¥—ñ–Ω–∫—É —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó –∫–æ–ª–∏ DZYGA —Å–∫–∞–Ω—É—î —á–∞—Å—Ç–æ—Ç–∏</span>
                    <select id="STREAM_MODE" name="STREAM_MODE">
                        <option value="always">–ó–∞–≤–∂–¥–∏ —Ç—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏ (—ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è)</option>
                        <option value="on-lock">–¢—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –∑—É–ø–∏–Ω—Ü—ñ (–ø–∞—É–∑–∞ –ø—ñ–¥ —á–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è)</option>
                        <option value="overlay">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä "–°–ö–ê–ù–£–í–ê–ù–ù–Ø..." –Ω–∞ –µ–∫—Ä–∞–Ω—ñ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="OVERLAY_FONTSIZE">–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É</label>
                    <input type="number" id="OVERLAY_FONTSIZE" name="OVERLAY_FONTSIZE" value="16" min="8" max="48">
                </div>

                <div class="form-group">
                    <label for="OVERLAY_BG_OPACITY">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ñ–æ–Ω—É (0.0 - 1.0)</label>
                    <input type="number" id="OVERLAY_BG_OPACITY" name="OVERLAY_BG_OPACITY" value="0.5" min="0" max="1" step="0.1">
                </div>

                <div class="form-group">
                    <label for="OVERLAY_TEXT_OPACITY">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—É (0.0 - 1.0)</label>
                    <input type="number" id="OVERLAY_TEXT_OPACITY" name="OVERLAY_TEXT_OPACITY" value="1.0" min="0" max="1" step="0.1">
                </div>

                <div class="section-title">–Ø–∫—ñ—Å—Ç—å –≤—ñ–¥–µ–æ</div>

                <div class="form-group">
                    <label for="VIDEO_CRF">CRF (—è–∫—ñ—Å—Ç—å –≤—ñ–¥–µ–æ)</label>
                    <span class="help-text">28-32 = –Ω–∏–∑—å–∫–∏–π CPU, 23-27 = –∫—Ä–∞—â–∞ —è–∫—ñ—Å—Ç—å</span>
                    <input type="number" id="VIDEO_CRF" name="VIDEO_CRF" value="28" min="18" max="35">
                </div>

                <div class="form-group">
                    <label for="VIDEO_FPS">–ö–∞–¥—Ä—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É (FPS)</label>
                    <span class="help-text">15 = –µ–∫–æ–Ω–æ–º—ñ—è —Ç—Ä–∞—Ñ—ñ–∫—É, 25 = –ø–ª–∞–≤–Ω–µ –≤—ñ–¥–µ–æ</span>
                    <span class="help-text" style="color: #666; font-style: italic;">‚ö†Ô∏è –ü—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–æ–¥—É–≤–∞–Ω–Ω—ñ (–∫–æ–ª–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –æ–≤–µ—Ä–ª–µ–π –∞–±–æ —á–∞—Å—Ç–æ—Ç—É)</span>
                    <input type="number" id="VIDEO_FPS" name="VIDEO_FPS" value="15" min="10" max="30">
                </div>

                <details style="margin-top: 16px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">–†–æ–∑—à–∏—Ä–µ–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</summary>

                    <div class="form-group" style="margin-top: 16px;">
                        <label for="USE_UDP_PROXY">UDP Proxy —Ä–µ–∂–∏–º</label>
                        <span class="help-text">–Ü–∑–æ–ª—é—î ffmpeg –≤—ñ–¥ RTSP –¥–∂–µ—Ä–µ–ª–∞, –∑–∞–ø–æ–±—ñ–≥–∞—î –±–ª–æ–∫—É–≤–∞–Ω–Ω—é —ñ–Ω—à–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤ (GStreamer/VLC)</span>
                        <span class="help-text" style="color: #28a745; font-weight: 600;">‚úì –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</span>
                        <select id="USE_UDP_PROXY" name="USE_UDP_PROXY">
                            <option value="true">–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
                            <option value="false">–í–∏–º–∫–Ω–µ–Ω–æ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="FORPOST_IP">IP –∞–¥—Ä–µ—Å–∞ FORPOST</label>
                        <span class="help-text">–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ "auto" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è</span>
                        <input type="text" id="FORPOST_IP" name="FORPOST_IP" value="auto">
                    </div>

                    <div class="form-group">
                        <label for="RTSP_PORT">RTSP –ø–æ—Ä—Ç</label>
                        <input type="number" id="RTSP_PORT" name="RTSP_PORT" value="8554">
                    </div>

                    <div class="form-group">
                        <label for="VIDEO_DEVICE">–í—ñ–¥–µ–æ –ø—Ä–∏—Å—Ç—Ä—ñ–π</label>
                        <input type="text" id="VIDEO_DEVICE" name="VIDEO_DEVICE" value="devvideo0">
                    </div>
                </details>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('statusBadge');
                    if (data.active) {
                        badge.className = 'status-badge status-active';
                        badge.textContent = '‚óè –ê–∫—Ç–∏–≤–Ω–∏–π';
                    } else {
                        badge.className = 'status-badge status-inactive';
                        badge.textContent = '‚óè –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π';
                    }
                    
                    // Update autostart checkbox
                    const checkbox = document.getElementById('autostartCheckbox');
                    if (checkbox) {
                        checkbox.checked = data.autostart || false;
                    }
                })
                .catch(err => console.error('Failed to fetch status:', err));
        }

        function setOperationBadge(text) {
            const b = document.getElementById('operationBadge');
            if (!b) return;
            b.style.display = 'inline-block';
            b.textContent = text;
        }

        function clearOperationBadge() {
            const b = document.getElementById('operationBadge');
            if (!b) return;
            b.style.display = 'none';
            b.textContent = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function waitForDesiredActiveState(desiredActive, timeoutMs) {
            const startTs = Date.now();
            return new Promise((resolve, reject) => {
                const tick = () => {
                    fetch('/api/status')
                        .then(r => r.json())
                        .then(s => {
                            if ((s.active || false) === desiredActive) {
                                resolve(s);
                                return;
                            }
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        })
                        .catch(() => {
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        });
                };
                tick();
            });
        }

        function waitForRestart(timeoutMs) {
            const startTs = Date.now();
            let sawNonActive = false;
            return new Promise((resolve, reject) => {
                const tick = () => {
                    fetch('/api/status')
                        .then(r => r.json())
                        .then(s => {
                            const status = (s.status || '').trim();
                            if (status && status !== 'active') {
                                sawNonActive = true;
                            }
                            if (sawNonActive && status === 'active') {
                                resolve(s);
                                return;
                            }
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        })
                        .catch(() => {
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        });
                };
                tick();
            });
        }

        function updateCpuModeBadge(config) {
            const badge = document.getElementById('cpuModeBadge');
            const hasOverlay = config.OVERLAY_TEXT && config.OVERLAY_TEXT.trim() !== '';
            const showFreq = config.SHOW_FREQUENCY === 'true';
            
            if (hasOverlay || showFreq) {
                badge.className = 'cpu-mode-badge cpu-high';
                let features = [];
                if (hasOverlay) features.push('–æ–≤–µ—Ä–ª–µ–π');
                if (showFreq) features.push('—á–∞—Å—Ç–æ—Ç–∞');
                badge.textContent = '‚ö†Ô∏è –í–∏—Å–æ–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è CPU (' + features.join(', ') + '). –ó–∞ —É–º–æ–≤–∏ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ —Ü–µ –Ω–µ —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º. –£ —Ä–∞–∑—ñ –∑–∞—Ç—Ä–∏–º–æ–∫ –∞–±–æ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–º–∫–Ω—É—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –Ω–∏–∂—á–µ. –£ —Ç–∞–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É —Ç–µ–∫—Å—Ç —Ç–∞/–∞–±–æ —á–∞—Å—Ç–æ—Ç–∞ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º—É—Ç—å—Å—è –Ω–∞ –≤—ñ–¥–µ–æ, –ø—Ä–æ—Ç–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –ø—Ä–∏—Å—Ç—Ä—ñ–π –±—É–¥–µ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–º.';
            } else {
                badge.className = 'cpu-mode-badge cpu-normal';
                badge.textContent = '‚úì –®—Ç–∞—Ç–Ω–∏–π —Ä–µ–∂–∏–º';
            }
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    const config = data.config;
                    for (const [key, value] of Object.entries(config)) {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = value;
                        }
                    }
                    updateCpuModeBadge(config);
                })
                .catch(err => {
                    showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ' + err.message, 'error');
                });
        }

        document.getElementById('configForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const config = {};
            for (const [key, value] of formData.entries()) {
                config[key] = value;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

            fetch('/api/status')
            .then(r => r.json())
            .then(statusBefore => {
                const wasActive = statusBefore.active || false;

                return fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('‚úÖ ' + data.message, 'success');
                        loadConfig();

                        if (wasActive) {
                            setOperationBadge('‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Ä¶');
                            const minVisibleMs = 1500;
                            const startedAt = Date.now();
                            return waitForRestart(25000)
                                .catch(() => null)
                                .then(() => updateStatus())
                                .finally(() => {
                                    const elapsed = Date.now() - startedAt;
                                    const remaining = Math.max(0, minVisibleMs - elapsed);
                                    setTimeout(() => {
                                        clearOperationBadge();
                                    }, remaining);
                                });
                        }
                    } else {
                        showAlert('‚ùå ' + data.error, 'error');
                    }
                });
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é';
            });
        });

        // Start stream button
        document.getElementById('startBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';
            setOperationBadge('‚è≥ –ó–∞–ø—É—Å–∫‚Ä¶');

            fetch('/api/stream/start', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    return waitForDesiredActiveState(true, 20000)
                        .then(() => {
                            clearOperationBadge();
                            updateStatus();
                        })
                        .catch(() => {
                            clearOperationBadge();
                            updateStatus();
                        });
                } else {
                    showAlert('‚ùå ' + data.error, 'error');
                    clearOperationBadge();
                }
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                clearOperationBadge();
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = originalText;
            });
        });

        // Stop stream button
        document.getElementById('stopBtn').addEventListener('click', function() {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑—É–ø–∏–Ω–∏—Ç–∏ —Å—Ç—Ä—ñ–º?')) {
                return;
            }

            const btn = this;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ó—É–ø–∏–Ω–∫–∞...';
            setOperationBadge('‚è≥ –ó—É–ø–∏–Ω–∫–∞‚Ä¶');

            fetch('/api/stream/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    return waitForDesiredActiveState(false, 20000)
                        .then(() => {
                            clearOperationBadge();
                            updateStatus();
                        })
                        .catch(() => {
                            clearOperationBadge();
                            updateStatus();
                        });
                } else {
                    showAlert('‚ùå ' + data.error, 'error');
                    clearOperationBadge();
                }
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                clearOperationBadge();
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = originalText;
            });
        });

        // Restart stream button
        document.getElementById('restartStreamBtn').addEventListener('click', function() {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç—Ä—ñ–º?')) {
                return;
            }

            const btn = this;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...';
            setOperationBadge('‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Ä¶');


            fetch('/api/stream/restart', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    return waitForDesiredActiveState(true, 25000)
                        .then(() => {
                            clearOperationBadge();
                            updateStatus();
                        })
                        .catch(() => {
                            clearOperationBadge();
                            updateStatus();
                        });
                } else {
                    showAlert('‚ùå ' + data.error, 'error');
                    clearOperationBadge();
                }
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                clearOperationBadge();
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = originalText;
            });
        });

        // Autostart checkbox
        document.getElementById('autostartCheckbox').addEventListener('change', function() {
            const enable = this.checked;
            
            fetch('/api/stream/autostart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enable: enable })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                } else {
                    showAlert('‚ùå ' + data.error, 'error');
                    // Revert checkbox on error
                    this.checked = !enable;
                }
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                // Revert checkbox on error
                this.checked = !enable;
            });
        });

        // Auto-restart checkbox
        document.getElementById('autorestartCheckbox').addEventListener('change', function() {
            const enable = this.checked;
            const intervalGroup = document.getElementById('autorestartIntervalGroup');
            
            // Show/hide interval input
            intervalGroup.style.display = enable ? 'block' : 'none';
            
            const interval = parseInt(document.getElementById('autorestartInterval').value) || 2;
            
            fetch('/api/autorestart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: enable, interval: interval })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                } else {
                    showAlert('‚ùå ' + data.error, 'error');
                    // Revert checkbox on error
                    this.checked = !enable;
                    intervalGroup.style.display = !enable ? 'block' : 'none';
                }
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                // Revert checkbox on error
                this.checked = !enable;
                intervalGroup.style.display = !enable ? 'block' : 'none';
            });
        });

        // Auto-restart interval change
        document.getElementById('autorestartInterval').addEventListener('change', function() {
            const enabled = document.getElementById('autorestartCheckbox').checked;
            if (!enabled) return;
            
            const interval = parseInt(this.value) || 2;
            
            fetch('/api/autorestart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: true, interval: interval })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ –ü–µ—Ä—ñ–æ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –æ–Ω–æ–≤–ª–µ–Ω–æ: ' + interval + '–≥–æ–¥', 'success');
                } else {
                    showAlert('‚ùå ' + data.error, 'error');
                }
            })
            .catch(err => {
                showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
            });
        });

        function loadAutorestartSettings() {
            fetch('/api/autorestart')
                .then(response => response.json())
                .then(data => {
                    const checkbox = document.getElementById('autorestartCheckbox');
                    const intervalInput = document.getElementById('autorestartInterval');
                    const intervalGroup = document.getElementById('autorestartIntervalGroup');
                    
                    checkbox.checked = data.enabled || false;
                    intervalInput.value = data.interval || 2;
                    intervalGroup.style.display = data.enabled ? 'block' : 'none';
                })
                .catch(err => console.error('Failed to load auto-restart settings:', err));
        }

        function checkUpdates() {
            const channel = document.getElementById('updateChannel').value;
            
            fetch(`/api/updates/check?channel=${channel}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Update check failed:', data.error);
                        return;
                    }
                    
                    document.getElementById('currentVersion').textContent = data.current;
                    document.getElementById('currentVersionBadge').textContent = data.current;
                    
                    // Show update card
                    document.getElementById('updateCard').style.display = 'block';
                    
                    // Show update available banner
                    if (data.has_update) {
                        document.getElementById('latestVersion').textContent = data.latest;
                        document.getElementById('updateAvailable').style.display = 'block';
                    } else {
                        document.getElementById('updateAvailable').style.display = 'none';
                    }
                    
                    // Build releases list
                    const updatesList = document.getElementById('updatesList');
                    updatesList.innerHTML = '';
                    
                    if (data.releases && data.releases.length > 0) {
                        data.releases.forEach(release => {
                            const isCurrent = release.version === `v${data.current}`;
                            const releaseDiv = document.createElement('div');
                            releaseDiv.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;';
                            
                            let badge = '';
                            if (isCurrent) {
                                badge = '<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">–ü–û–¢–û–ß–ù–ê</span>';
                            } else if (release.prerelease) {
                                badge = '<span style="background: #ffc107; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">BETA</span>';
                            }
                            
                            releaseDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <strong>${release.version}</strong>
                                        ${badge}
                                    </div>
                                    <div>
                                        ${isCurrent ? '' : `<button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="installUpdate('${release.version}')">–û–Ω–æ–≤–∏—Ç–∏</button>`}
                                    </div>
                                </div>
                                ${release.body ? `<div style="font-size: 12px; color: #666; white-space: pre-wrap;">${release.body.substring(0, 200)}${release.body.length > 200 ? '...' : ''}</div>` : ''}
                            `;
                            
                            updatesList.appendChild(releaseDiv);
                        });
                    } else {
                        updatesList.innerHTML = '<p style="color: #666;">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å</p>';
                    }
                })
                .catch(err => {
                    console.error('Failed to check updates:', err);
                });
        }
        function installUpdate(version) {
            if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ –¥–æ –≤–µ—Ä—Å—ñ—ó ${version}?`)) {
                return;
            }
            
            const overlay = document.getElementById('updateOverlay');
            const message = document.getElementById('updateMessage');
            
            overlay.classList.add('show');
            message.textContent = '–ó–∞–ø—É—Å–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è...';
            
            fetch('/api/updates/install', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ version: version })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    message.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è... –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞...';
                    
                    // Wait 5 seconds for services to stop, then start polling
                    setTimeout(() => {
                        let attempts = 0;
                        let serverWentDown = false;
                        
                        const checkInterval = setInterval(() => {
                            attempts++;
                            
                            fetch('/api/status', { cache: 'no-cache' })
                                .then(() => {
                                    // Server is up
                                    if (serverWentDown) {
                                        // Server came back after going down - update complete!
                                        clearInterval(checkInterval);
                                        message.textContent = '‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                                        setTimeout(() => location.reload(true), 500);
                                    }
                                })
                                .catch(() => {
                                    // Server is down - update in progress
                                    serverWentDown = true;
                                    message.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è... –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è...';
                                });
                            
                            if (attempts > 40) {
                                clearInterval(checkInterval);
                                overlay.classList.remove('show');
                                showAlert('‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–æ–∂–µ —Ç—Ä–∏–≤–∞—Ç–∏ –¥–æ–≤—à–µ. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ä—É—á–Ω—É.', 'warning');
                            }
                        }, 1000);
                    }, 5000);
                } else {
                    overlay.classList.remove('show');
                    showAlert('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞'), 'error');
                }
            })
            .catch(err => {
                overlay.classList.remove('show');
                showAlert('‚ùå ' + err.message, 'error');
            });
        }
        
        
        
        function toggleUpdateSection() {
            const content = document.getElementById('updateContent');
            const icon = document.getElementById('updateToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }
        
        // Update channel change handler
        document.getElementById('updateChannel').addEventListener('change', checkUpdates);

        loadConfig();
        updateStatus();
        loadAutorestartSettings();
        checkUpdates();
        setInterval(updateStatus, 10000);
        setInterval(checkUpdates, 300000); // Check updates every 5 minutes
    </script>
</body>
</html>
