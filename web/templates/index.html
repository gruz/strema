<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORPOST Stream - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group .help-text {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.show {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes blink-red {

            0%,
            100% {
                border-color: #ccc;
                box-shadow: none;
            }

            50% {
                border-color: #dc3545;
                box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
            }
        }

        .update-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .update-overlay.show {
            display: flex;
        }

        .update-overlay .spinner {
            border-color: #f3f3f3;
            border-top-color: #667eea;
            width: 60px;
            height: 60px;
            border-width: 6px;
        }

        .update-overlay .message {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
        }

        /* Tab System Styles */
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            flex: 1;
        }

        .tab-btn:hover {
            color: #333;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: block;
        }

        .form-group textarea {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: vertical;
            white-space: pre;
            tab-size: 4;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .backup-info {
            display: none;
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            background: #e2e3e5;
            border: 1px solid #d6d8db;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .backup-item span {
            font-size: 12px;
        }

        .backup-actions {
            display: flex;
            gap: 4px;
        }

        .backup-btn {
            font-size: 11px;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .backup-view {
            background: #6c757d;
            color: white;
        }

        .backup-restore {
            background: #dc3545;
            color: white;
        }

        /* Header styles */
        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .cpu-mode-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
            margin-left: 8px;
        }

        .cpu-high {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body>
    <div id="updateOverlay" class="update-overlay">
        <div class="spinner"></div>
        <div class="message" id="updateMessage">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üé• FORPOST Stream</h1>
            <p>{{ header_title }} <span style="color: #999; font-size: 12px;">v{{ version }}</span>
                {% if firmware_serial %}
                <span style="color: #999; font-size: 12px; margin-left: 12px;">ID: 
                    <em style="border:1px solid #ccc; padding:2px">{{ firmware_serial }}</em>
                    <button onclick="var t=document.createElement('textarea');t.value='{{ firmware_serial }}';document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);this.textContent='‚úÖ';var b=this;setTimeout(function(){b.textContent='üìã'},1500)"
                        style="border:none;background:none;cursor:pointer;font-size:12px;padding:2px 4px;" title="–ö–æ–ø—ñ—é–≤–∞—Ç–∏ ID">üìã</button>
                </span>
                {% endif %}
            </p>
            <div>
                <span id="statusBadge"></span>
                {% if show_cpu_mode %}
                <span id="operationBadge" class="status-badge status-pending" style="display:none;"></span>
                <span id="cpuModeBadge" class="cpu-mode-badge cpu-high">‚ö° –ü–µ—Ä–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è</span>
                {% endif %}
            </div>
        </div>

        <div id="alertBox" class="alert"></div>


        <div class="card" id="updateCard">
            <div class="section-title"
                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                onclick="toggleUpdateSection()">
                <span>üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ <span style="font-size: 12px; color: #999;">(–≤–µ—Ä—Å—ñ—è: <span
                            id="currentVersionBadge">...</span>)</span> <span id="newVersionBadge"
                        style="display: none; background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">–ù–û–í–ê
                        –í–ï–†–°–Ü–Ø</span></span>
                <span id="updateToggleIcon" style="font-size: 20px;">‚ñº</span>
            </div>

            <div id="updateContent" style="display: none; margin-top: 12px;">
                <div style="margin-bottom: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <strong>–ü–æ—Ç–æ—á–Ω–∞ –≤–µ—Ä—Å—ñ—è:</strong> <span id="currentVersion">...</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="font-weight: normal; margin: 0;">
                                –ö–∞–Ω–∞–ª:
                                <select id="updateChannel" style="width: auto; padding: 4px 8px; margin-left: 8px;">
                                    <option value="stable">Stable</option>
                                    <option value="beta">Beta</option>
                                </select>
                            </label>
                            <button class="btn btn-secondary" onclick="forceCheckUpdates()" style="padding: 4px 12px; font-size: 12px;">
                                üîÑ –û–Ω–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑
                            </button>
                        </div>
                    </div>

                    <div id="updateAvailable"
                        style="display: none; background: #d4edda; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <strong style="color: #155724;">‚ú® –î–æ—Å—Ç—É–ø–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ —Ä–µ–ª—ñ–∑—É: <span id="latestVersion"></span></strong>
                    </div>

                    <div id="updatesList"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—ñ–º—ñ–Ω–≥–æ–º</div>

            <div class="button-group">
                <button type="button" class="btn btn-primary" id="startBtn">
                    ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç—Ä—ñ–º
                </button>
                <button type="button" class="btn btn-secondary" id="stopBtn">
                    ‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ —Å—Ç—Ä—ñ–º
                </button>
                <button type="button" class="btn btn-secondary" id="restartStreamBtn">
                    üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç—Ä—ñ–º
                </button>
            </div>
        </div>


        <div class="card">
            <!-- Tab Navigation -->
            <div style="display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                <button type="button" class="tab-btn active" id="formTab" onclick="switchTab('form')">
                    üìù –§–æ—Ä–º–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
                </button>
                <button type="button" class="tab-btn" id="rawTab" onclick="switchTab('raw')">
                    üìÑ –¢–µ–∫—Å—Ç–æ–≤–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
                </button>
            </div>

            <!-- Form Tab Content -->
            <div id="formTabContent" class="tab-content">
                <form id="configForm">
                    <div class="section-title">–û—Å–Ω–æ–≤–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>

                    <div class="form-group">
                        <label for="RTMP_URL">RTMP URL</label>
                        <span class="help-text">–ü–æ–≤–Ω–∏–π URL –¥–ª—è —Å—Ç—Ä—ñ–º—É (–Ω–∞–ø—Ä. rtmps://server:port/app/key)</span>
                        <input type="text" id="RTMP_URL" name="RTMP_URL" required>
                    </div>

                    <div class="section-title">–û–≤–µ—Ä–ª–µ–π –Ω–∞ –≤—ñ–¥–µ–æ</div>

                    <div class="form-group">
                        <label for="OVERLAY_ENABLED">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –æ–≤–µ—Ä–ª–µ–π</label>
                        <span class="help-text" style="color: #d9534f; font-weight: 600;">‚ö†Ô∏è –£–í–ê–ì–ê: –û–≤–µ—Ä–ª–µ–π –∑–±—ñ–ª—å—à—É—î
                            –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ CPU —ñ –≤–∏–º–∏–∫–∞—î –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Å—Ç—Ä—ñ–º—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–µ—Ä–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è)</span>
                        <select id="OVERLAY_ENABLED" name="OVERLAY_ENABLED">
                            <option value="true" selected>–¢–∞–∫</option>
                            <option value="false">–ù—ñ</option>
                        </select>
                    </div>

                    <div id="overlayOptionsSection" style="display: block;">
                        <!-- Static Overlay -->
                        <div class="section-title"
                            style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 20px;"
                            onclick="toggleStaticOverlay()">
                            <span>üìù –°—Ç–∞—Ç–∏—á–Ω–∏–π —Ç–µ–∫—Å—Ç</span>
                            <span id="staticOverlayIcon" style="font-size: 20px;">‚ñº</span>
                        </div>

                        <div id="staticOverlaySection"
                            style="display: none; margin: 12px 0; padding: 20px; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px;">
                            <div class="form-group">
                                <label for="OVERLAY_TEXT">–¢–µ–∫—Å—Ç –æ–≤–µ—Ä–ª–µ—é</label>
                                <span class="help-text">–°—Ç–∞—Ç–∏—á–Ω–∏–π —Ç–µ–∫—Å—Ç, —è–∫–∏–π –∑–∞–≤–∂–¥–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –Ω–∞ –≤—ñ–¥–µ–æ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥,
                                    –Ω–æ–º–µ—Ä –ø—Ä–∏—Å—Ç—Ä–æ—é, —É–º–æ–≤–Ω–µ –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è</span>
                                <input type="text" id="OVERLAY_TEXT" name="OVERLAY_TEXT"
                                    placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: [N] –¥–∑–∏–≥–∞">
                            </div>

                            <div class="form-group">
                                <label for="OVERLAY_POSITION">–ü–æ–∑–∏—Ü—ñ—è —Ç–µ–∫—Å—Ç—É</label>
                                <select id="OVERLAY_POSITION" name="OVERLAY_POSITION">
                                    <option value="top-left">–ó–≤–µ—Ä—Ö—É –∑–ª—ñ–≤–∞</option>
                                    <option value="top-right">–ó–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞</option>
                                    <option value="bottom-left">–ó–Ω–∏–∑—É –∑–ª—ñ–≤–∞</option>
                                    <option value="bottom-right">–ó–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</option>
                                </select>
                            </div>

                            <div class="section-title"
                                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 14px;"
                                onclick="toggleStaticSettings()">
                                <span>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                                <span id="staticSettingsIcon" style="font-size: 16px;">‚ñº</span>
                            </div>

                            <div id="staticSettings"
                                style="display: none; margin: 12px 0; padding: 15px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div class="form-group">
                                    <label for="OVERLAY_FONTSIZE_CUSTOM">–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É</label>
                                    <input type="number" id="OVERLAY_FONTSIZE_CUSTOM" name="OVERLAY_FONTSIZE_CUSTOM"
                                        value="20" min="8" max="72">
                                </div>

                                <div class="form-group">
                                    <label for="OVERLAY_TEXT_COLOR">–ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É</label>
                                    <select id="OVERLAY_TEXT_COLOR" name="OVERLAY_TEXT_COLOR">
                                        <option value="white" selected>–ë—ñ–ª–∏–π</option>
                                        <option value="yellow">–ñ–æ–≤—Ç–∏–π</option>
                                        <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                        <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                        <option value="blue">–°–∏–Ω—ñ–π</option>
                                        <option value="orange">–ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π</option>
                                        <option value="cyan">–ë–ª–∞–∫–∏—Ç–Ω–∏–π</option>
                                        <option value="magenta">–ü—É—Ä–ø—É—Ä–Ω–∏–π</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="OVERLAY_TEXT_OPACITY_CUSTOM">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—É (0.0 - 1.0)</label>
                                    <input type="number" id="OVERLAY_TEXT_OPACITY_CUSTOM"
                                        name="OVERLAY_TEXT_OPACITY_CUSTOM" value="1.0" min="0" max="1" step="0.1">
                                </div>

                                <div class="form-group">
                                    <label for="OVERLAY_BORDER_WIDTH">–¢–æ–≤—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏ (0 = —Ñ–æ–Ω)</label>
                                    <span class="help-text">–û–±–≤–æ–¥–∫–∞ —Ä–æ–±–∏—Ç—å —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º –Ω–∞ –±—É–¥—å-—è–∫–æ–º—É —Ç–ª—ñ</span>
                                    <input type="number" id="OVERLAY_BORDER_WIDTH" name="OVERLAY_BORDER_WIDTH" value="0"
                                        min="0" max="10">
                                </div>

                                <div id="staticBgGroup" style="display: block;">
                                    <div class="form-group">
                                        <label for="OVERLAY_BG_COLOR">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É</label>
                                        <select id="OVERLAY_BG_COLOR" name="OVERLAY_BG_COLOR">
                                            <option value="black" selected>–ß–æ—Ä–Ω–∏–π</option>
                                            <option value="white">–ë—ñ–ª–∏–π</option>
                                            <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                            <option value="blue">–°–∏–Ω—ñ–π</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="OVERLAY_BG_OPACITY_CUSTOM">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ñ–æ–Ω—É (0.0 - 1.0)</label>
                                        <input type="number" id="OVERLAY_BG_OPACITY_CUSTOM"
                                            name="OVERLAY_BG_OPACITY_CUSTOM" value="0.5" min="0" max="1" step="0.1">
                                    </div>
                                </div>

                                <div id="staticBorderGroup" style="display: none;">
                                    <div class="form-group">
                                        <label for="OVERLAY_BORDER_COLOR">–ö–æ–ª—ñ—Ä –æ–±–≤–æ–¥–∫–∏</label>
                                        <select id="OVERLAY_BORDER_COLOR" name="OVERLAY_BORDER_COLOR">
                                            <option value="black" selected>–ß–æ—Ä–Ω–∏–π</option>
                                            <option value="white">–ë—ñ–ª–∏–π</option>
                                            <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                            <option value="blue">–°–∏–Ω—ñ–π</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Frequency Display -->
                        <div class="section-title"
                            style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 20px;"
                            onclick="toggleFrequencyOverlay()">
                            <span>üì° –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–∞—Å—Ç–æ—Ç–∏</span>
                            <span id="frequencyOverlayIcon" style="font-size: 20px;">‚ñº</span>
                        </div>

                        <div id="frequencyOverlaySection"
                            style="display: none; margin: 12px 0; padding: 20px; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px;">
                            <div class="form-group">
                                <label for="SHOW_FREQUENCY">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —á–∞—Å—Ç–æ—Ç—É</label>
                                <select id="SHOW_FREQUENCY" name="SHOW_FREQUENCY">
                                    <option value="true">–¢–∞–∫</option>
                                    <option value="false">–ù—ñ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="FREQUENCY_POSITION">–ü–æ–∑–∏—Ü—ñ—è —á–∞—Å—Ç–æ—Ç–∏</label>
                                <select id="FREQUENCY_POSITION" name="FREQUENCY_POSITION">
                                    <option value="top-left">–ó–≤–µ—Ä—Ö—É –∑–ª—ñ–≤–∞</option>
                                    <option value="top-right">–ó–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞</option>
                                    <option value="bottom-left">–ó–Ω–∏–∑—É –∑–ª—ñ–≤–∞</option>
                                    <option value="bottom-right">–ó–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</option>
                                </select>
                            </div>

                            <div class="section-title"
                                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 14px;"
                                onclick="toggleFrequencySettings()">
                                <span>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                                <span id="frequencySettingsIcon" style="font-size: 16px;">‚ñº</span>
                            </div>

                            <div id="frequencySettings"
                                style="display: none; margin: 12px 0; padding: 15px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div class="form-group">
                                    <label for="FREQUENCY_FONTSIZE">–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É</label>
                                    <input type="number" id="FREQUENCY_FONTSIZE" name="FREQUENCY_FONTSIZE" value="20"
                                        min="8" max="72">
                                </div>

                                <div class="form-group">
                                    <label for="FREQUENCY_TEXT_COLOR">–ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É</label>
                                    <select id="FREQUENCY_TEXT_COLOR" name="FREQUENCY_TEXT_COLOR">
                                        <option value="white">–ë—ñ–ª–∏–π</option>
                                        <option value="yellow" selected>–ñ–æ–≤—Ç–∏–π</option>
                                        <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                        <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                        <option value="blue">–°–∏–Ω—ñ–π</option>
                                        <option value="orange">–ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π</option>
                                        <option value="cyan">–ë–ª–∞–∫–∏—Ç–Ω–∏–π</option>
                                        <option value="magenta">–ü—É—Ä–ø—É—Ä–Ω–∏–π</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="FREQUENCY_TEXT_OPACITY">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—É (0.0 - 1.0)</label>
                                    <input type="number" id="FREQUENCY_TEXT_OPACITY" name="FREQUENCY_TEXT_OPACITY"
                                        value="1.0" min="0" max="1" step="0.1">
                                </div>

                                <div class="form-group">
                                    <label for="FREQUENCY_BORDER_WIDTH">–¢–æ–≤—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏ (0 = —Ñ–æ–Ω)</label>
                                    <span class="help-text">–û–±–≤–æ–¥–∫–∞ —Ä–æ–±–∏—Ç—å —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º –Ω–∞ –±—É–¥—å-—è–∫–æ–º—É —Ç–ª—ñ</span>
                                    <input type="number" id="FREQUENCY_BORDER_WIDTH" name="FREQUENCY_BORDER_WIDTH"
                                        value="0" min="0" max="10">
                                </div>

                                <div id="frequencyBgGroup" style="display: block;">
                                    <div class="form-group">
                                        <label for="FREQUENCY_BG_COLOR">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É</label>
                                        <select id="FREQUENCY_BG_COLOR" name="FREQUENCY_BG_COLOR">
                                            <option value="black" selected>–ß–æ—Ä–Ω–∏–π</option>
                                            <option value="white">–ë—ñ–ª–∏–π</option>
                                            <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                            <option value="blue">–°–∏–Ω—ñ–π</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="FREQUENCY_BG_OPACITY">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ñ–æ–Ω—É (0.0 - 1.0)</label>
                                        <input type="number" id="FREQUENCY_BG_OPACITY" name="FREQUENCY_BG_OPACITY"
                                            value="0.5" min="0" max="1" step="0.1">
                                    </div>
                                </div>

                                <div id="frequencyBorderGroup" style="display: none;">
                                    <div class="form-group">
                                        <label for="FREQUENCY_BORDER_COLOR">–ö–æ–ª—ñ—Ä –æ–±–≤–æ–¥–∫–∏</label>
                                        <select id="FREQUENCY_BORDER_COLOR" name="FREQUENCY_BORDER_COLOR">
                                            <option value="black" selected>–ß–æ—Ä–Ω–∏–π</option>
                                            <option value="white">–ë—ñ–ª–∏–π</option>
                                            <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                            <option value="blue">–°–∏–Ω—ñ–π</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Overlay -->
                        <div class="section-title"
                            style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 20px;"
                            onclick="toggleDynamicOverlay()">
                            <span>üî§ –î–∏–Ω–∞–º—ñ—á–Ω–∏–π –æ–≤–µ—Ä–ª–µ–π</span>
                            <span id="dynamicOverlayIcon" style="font-size: 20px;">‚ñº</span>
                        </div>

                        <div id="dynamicOverlaySection"
                            style="display: none; margin: 12px 0; padding: 20px; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px;">
                            <div class="form-group">
                                <label for="dynamicOverlayText">–¢–µ–∫—Å—Ç –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ</label>
                                <span class="help-text" style="display: block; margin-bottom: 8px;">
                                    <strong>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:</strong> –í–∏–≤–µ–¥–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –æ–±'—î–∫—Ç –Ω–∞ –≤—ñ–¥–µ–æ (–Ω–∞—Å–µ–ª–µ–Ω–∏–π
                                    –ø—É–Ω–∫—Ç, –æ—Ä—ñ—î–Ω—Ç–∏—Ä–∏, –Ω–∞–ø—Ä—è–º —Ä—É—Ö—É, –∑–º—ñ–Ω–∏ –ø–æ–∑–∏—Ü—ñ—ó).
                                    –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–î—Ä–æ–Ω –Ω–∞–¥ —Å.–°–º–µ—Ä—Ç—å–º–æ—Å–∫–∞–ª—å—Å—å–∫–µ, —Ä—É—Ö –Ω–∞ –ø—ñ–≤–Ω—ñ—á".
                                    –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –Ω–∞ —ñ–Ω—à—É —á–∞—Å—Ç–æ—Ç—É —Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—î—Ç—å—Å—è, —â–æ–± –Ω–µ –≤–≤–æ–¥–∏—Ç–∏ –≤ –æ–º–∞–Ω—É.
                                </span>
                                <span class="help-text">üí° <strong>–ö–µ—Ä—É–≤–∞–Ω–Ω—è:</strong> Enter ‚Äî –∑–±–µ—Ä–µ–≥—Ç–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ñ–¥–µ–æ ‚Ä¢
                                    Escape –∞–±–æ ‚úï ‚Äî –æ—á–∏—Å—Ç–∏—Ç–∏ ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∏–∫–∞—î –ø—Ä–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ</span>
                                <div style="position: relative;">
                                    <input type="text" id="dynamicOverlayText"
                                        placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter..." style="padding-right: 35px;">
                                    <button type="button" id="clearDynamicText"
                                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; font-size: 18px; cursor: pointer; padding: 5px 10px; display: none;"
                                        title="–û—á–∏—Å—Ç–∏—Ç–∏ —Ç–µ–∫—Å—Ç">‚úï</button>
                                </div>
                            </div>
                            <div style="margin-top: 8px; padding: 8px 12px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 8px;"
                                id="scanningStatus">
                                <span id="scanningIndicator"
                                    style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #28a745;"></span>
                                <span id="scanningText" style="font-weight: 600; color: #28a745;">–ß–∞—Å—Ç–æ—Ç–∞
                                    —Å—Ç–∞–±—ñ–ª—å–Ω–∞</span>
                            </div>
                            <div
                                style="margin-top: 12px; padding: 12px; background: #f0f0f0; border-radius: 8px; font-size: 13px; color: #666;">
                                <strong>–ü–æ—Ç–æ—á–Ω–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ñ–¥–µ–æ:</strong> <span id="currentDynamicText"
                                    style="color: #333; font-weight: 600;">‚Äî</span>
                            </div>

                            <!-- Dynamic Overlay Settings -->
                            <div class="section-title"
                                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 14px;"
                                onclick="toggleDynamicOverlaySettings()">
                                <span>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                                <span id="dynamicOverlaySettingsIcon" style="font-size: 16px;">‚ñº</span>
                            </div>

                            <div id="dynamicOverlaySettings"
                                style="display: none; margin: 12px 0; padding: 15px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px;">
                                <div class="form-group">
                                    <label for="DYNAMIC_OVERLAY_POSITION">–ü–æ–∑–∏—Ü—ñ—è</label>
                                    <select id="DYNAMIC_OVERLAY_POSITION" name="DYNAMIC_OVERLAY_POSITION">
                                        <option value="top-left">–ó–≤–µ—Ä—Ö—É –∑–ª—ñ–≤–∞</option>
                                        <option value="top-right">–ó–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞</option>
                                        <option value="bottom-left" selected>–ó–Ω–∏–∑—É –∑–ª—ñ–≤–∞</option>
                                        <option value="bottom-right">–ó–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="DYNAMIC_OVERLAY_FONTSIZE">–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É</label>
                                    <input type="number" id="DYNAMIC_OVERLAY_FONTSIZE" name="DYNAMIC_OVERLAY_FONTSIZE"
                                        value="20" min="8" max="72">
                                </div>

                                <div class="form-group">
                                    <label for="DYNAMIC_OVERLAY_TEXT_COLOR">–ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É</label>
                                    <select id="DYNAMIC_OVERLAY_TEXT_COLOR" name="DYNAMIC_OVERLAY_TEXT_COLOR">
                                        <option value="white">–ë—ñ–ª–∏–π</option>
                                        <option value="yellow">–ñ–æ–≤—Ç–∏–π</option>
                                        <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                        <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                        <option value="blue">–°–∏–Ω—ñ–π</option>
                                        <option value="orange">–ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π</option>
                                        <option value="cyan">–ë–ª–∞–∫–∏—Ç–Ω–∏–π</option>
                                        <option value="magenta">–ü—É—Ä–ø—É—Ä–Ω–∏–π</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="DYNAMIC_OVERLAY_TEXT_OPACITY">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—É (0.0 - 1.0)</label>
                                    <input type="number" id="DYNAMIC_OVERLAY_TEXT_OPACITY"
                                        name="DYNAMIC_OVERLAY_TEXT_OPACITY" value="1.0" min="0" max="1" step="0.1">
                                </div>

                                <div class="form-group">
                                    <label for="DYNAMIC_OVERLAY_BORDER_WIDTH">–¢–æ–≤—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏ (0 = —Ñ–æ–Ω)</label>
                                    <span class="help-text">–û–±–≤–æ–¥–∫–∞ —Ä–æ–±–∏—Ç—å —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º –Ω–∞ –±—É–¥—å-—è–∫–æ–º—É —Ç–ª—ñ</span>
                                    <input type="number" id="DYNAMIC_OVERLAY_BORDER_WIDTH"
                                        name="DYNAMIC_OVERLAY_BORDER_WIDTH" value="0" min="0" max="10">
                                </div>

                                <div id="dynamicBgGroup" style="display: block;">
                                    <div class="form-group">
                                        <label for="DYNAMIC_OVERLAY_BG_COLOR">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É</label>
                                        <select id="DYNAMIC_OVERLAY_BG_COLOR" name="DYNAMIC_OVERLAY_BG_COLOR">
                                            <option value="black">–ß–æ—Ä–Ω–∏–π</option>
                                            <option value="white">–ë—ñ–ª–∏–π</option>
                                            <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                            <option value="blue">–°–∏–Ω—ñ–π</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="DYNAMIC_OVERLAY_BG_OPACITY">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —Ñ–æ–Ω—É (0.0 - 1.0)</label>
                                        <input type="number" id="DYNAMIC_OVERLAY_BG_OPACITY"
                                            name="DYNAMIC_OVERLAY_BG_OPACITY" value="0.5" min="0" max="1" step="0.1">
                                    </div>
                                </div>

                                <div id="dynamicBorderGroup" style="display: none;">
                                    <div class="form-group">
                                        <label for="DYNAMIC_OVERLAY_BORDER_COLOR">–ö–æ–ª—ñ—Ä –æ–±–≤–æ–¥–∫–∏</label>
                                        <select id="DYNAMIC_OVERLAY_BORDER_COLOR" name="DYNAMIC_OVERLAY_BORDER_COLOR">
                                            <option value="black">–ß–æ—Ä–Ω–∏–π</option>
                                            <option value="white">–ë—ñ–ª–∏–π</option>
                                            <option value="red">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
                                            <option value="green">–ó–µ–ª–µ–Ω–∏–π</option>
                                            <option value="blue">–°–∏–Ω—ñ–π</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">–†–µ–∂–∏–º —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó</div>

                    <div class="form-group">
                        <label for="STREAM_MODE">–†–µ–∂–∏–º –ø—Ä–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ</label>
                        <span class="help-text">–í–∏–∑–Ω–∞—á–∞—î –ø–æ–≤–µ–¥—ñ–Ω–∫—É —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó –∫–æ–ª–∏ DZYGA —Å–∫–∞–Ω—É—î —á–∞—Å—Ç–æ—Ç–∏. –î–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å
                            —Ç—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏ –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –∑—É–ø–∏–Ω–µ–Ω–æ –Ω–∞ –ø–µ–≤–Ω—ñ–π —á–∞—Å—Ç–æ—Ç—ñ —á–∏ —Ç—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏ –∑–∞–≤–∂–¥–∏.
                            –¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –ª–∏—à–µ –∫–æ–ª–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –∑—É–ø–∏–Ω–µ–Ω–æ, –¥–æ–∑–≤–æ–ª—è—î –º–∞—Ç–∏ –∑–∞–ø–∏—Å–∏ –∫–æ–∂–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –≤
                            –æ–∫—Ä–µ–º–∏—Ö –±–ª–æ–∫–∞—Ö.</span>
                        <select id="STREAM_MODE" name="STREAM_MODE">
                            <option value="always">–ó–∞–≤–∂–¥–∏ —Ç—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏, –Ω–∞–≤—ñ—Ç—å –ø—ñ–¥ —á–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è</option>
                            <option value="on-lock">–¢—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –∑—É–ø–∏–Ω—Ü—ñ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è</option>
                            <option value="overlay">–ó–∞–≤–∂–¥–∏ —Ç—Ä–∞–Ω—Å–ª—é–≤–∞—Ç–∏, –Ω–∞–≤—ñ—Ç—å –ø—ñ–¥ —á–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è, –¥–æ–¥–∞–≤–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä
                                "–°–ö–ê–ù–£–í–ê–ù–ù–Ø..."</option>
                        </select>
                    </div>

                    <div class="section-title">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è</div>

                    <div class="form-group">
                        <label for="AUTOSTART_ENABLED">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ</label>
                        <span class="help-text">–Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ, —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è —Å—Ç–∞—Ä—Ç—É—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω—ñ
                            –î–∑–∏–≥–∏</span>
                        <select id="AUTOSTART_ENABLED" name="AUTOSTART_ENABLED">
                            <option value="true">–¢–∞–∫</option>
                            <option value="false" selected>–ù—ñ</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label for="AUTO_RESTART_ENABLED">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó</label>
                            <span class="help-text">–î–æ–∑–≤–æ–ª—è—î —É–Ω–∏–∫–Ω—É—Ç–∏ –æ–¥–Ω–æ–≥–æ –¥–æ–≤–≥–æ–≥–æ —Ñ–∞–π–ª—É –∑–∞–ø–∏—Å—É —Ç—Ä–∞–Ω—Å–ª—è—Ü—è—ó, –±'—î –Ω–∞
                                –±–ª–æ–∫–∏</span>
                            <select id="AUTO_RESTART_ENABLED" name="AUTO_RESTART_ENABLED">
                                <option value="true">–¢–∞–∫</option>
                                <option value="false" selected>–ù—ñ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="AUTO_RESTART_INTERVAL">–ü–µ—Ä—ñ–æ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É (–≥–æ–¥–∏–Ω–∏)</label>
                            <span class="help-text">–Ü–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó</span>
                            <input type="number" id="AUTO_RESTART_INTERVAL" name="AUTO_RESTART_INTERVAL" value="2"
                                min="1" max="24">
                        </div>
                    </div>

                    <div class="section-title">–Ø–∫—ñ—Å—Ç—å –≤—ñ–¥–µ–æ</div>

                    <div class="form-group">
                        <label for="VIDEO_CRF">CRF (—è–∫—ñ—Å—Ç—å –≤—ñ–¥–µ–æ)</label>
                        <span class="help-text">28-32 = –Ω–∏–∑—å–∫–∏–π CPU, 23-27 = –∫—Ä–∞—â–∞ —è–∫—ñ—Å—Ç—å</span>
                        <input type="number" id="VIDEO_CRF" name="VIDEO_CRF" value="28" min="18" max="35">
                    </div>

                    <div class="form-group">
                        <label for="VIDEO_FPS">–ö–∞–¥—Ä—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É (FPS)</label>
                        <span class="help-text">15 = –µ–∫–æ–Ω–æ–º—ñ—è —Ç—Ä–∞—Ñ—ñ–∫—É, 25 = –ø–ª–∞–≤–Ω–µ –≤—ñ–¥–µ–æ</span>
                        <span class="help-text" style="color: #666; font-style: italic;">‚ö†Ô∏è –ü—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏
                            –ø–µ—Ä–µ–∫–æ–¥—É–≤–∞–Ω–Ω—ñ (–∫–æ–ª–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –æ–≤–µ—Ä–ª–µ–π –∞–±–æ —á–∞—Å—Ç–æ—Ç—É)</span>
                        <input type="number" id="VIDEO_FPS" name="VIDEO_FPS" value="15" min="10" max="30">
                    </div>

                    <details style="margin-top: 16px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #333;">–†–æ–∑—à–∏—Ä–µ–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                        </summary>

                        <div class="form-group" style="margin-top: 16px;">
                            <label for="USE_UDP_PROXY">UDP Proxy —Ä–µ–∂–∏–º</label>
                            <span class="help-text">–Ü–∑–æ–ª—é—î ffmpeg –≤—ñ–¥ RTSP –¥–∂–µ—Ä–µ–ª–∞, –∑–∞–ø–æ–±—ñ–≥–∞—î –±–ª–æ–∫—É–≤–∞–Ω–Ω—é —ñ–Ω—à–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤
                                (GStreamer/VLC)</span>
                            <span class="help-text" style="color: #28a745; font-weight: 600;">‚úì –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ:
                                —É–≤—ñ–º–∫–Ω–µ–Ω–æ</span>
                            <select id="USE_UDP_PROXY" name="USE_UDP_PROXY">
                                <option value="true">–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
                                <option value="false">–í–∏–º–∫–Ω–µ–Ω–æ</option>
                            </select>
                        </div>

                        <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #e0e0e0;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 12px;">
                                ‚ö° –ï–Ω–µ—Ä–≥–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è <span style="font-size: 12px; color: #999; font-weight: normal;">(–¥–ª—è
                                    –¥–æ–≤–≥–∏—Ö PoE –∫–∞–±–µ–ª—ñ–≤)</span>
                            </div>

                            <div
                                style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ffc107;">
                                <strong style="color: #856404;">üí° –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:</strong>
                                <p style="margin: 8px 0 0 0; font-size: 13px; color: #856404;">
                                    –ü—Ä–∏ –∂–∏–≤–ª–µ–Ω–Ω—ñ —á–µ—Ä–µ–∑ PoE –Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—ñ 80-100–º –º–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑—ñ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—é —á–µ—Ä–µ–∑
                                    –ø–∞–¥—ñ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏.
                                    –í–∏–º–∫–Ω–µ–Ω–Ω—è –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –∑–º–µ–Ω—à—É—î —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –Ω–∞ 2-3W —ñ –ø—ñ–¥–≤–∏—â—É—î
                                    —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å.
                                </p>
                            </div>

                            <div class="form-group">
                                <label for="POWER_SAVE_WIFI">–í–∏–º–∫–Ω—É—Ç–∏ WiFi</label>
                                <span class="help-text">–ï–∫–æ–Ω–æ–º—ñ—è ~1W. –í–∏–º–∏–∫–∞–π—Ç–µ, —è–∫—â–æ WiFi –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.</span>
                                <select id="POWER_SAVE_WIFI" name="POWER_SAVE_WIFI">
                                    <option value="false">–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
                                    <option value="true">–í–∏–º–∫–Ω–µ–Ω–æ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="POWER_SAVE_BLUETOOTH">–í–∏–º–∫–Ω—É—Ç–∏ Bluetooth</label>
                                <span class="help-text">–ï–∫–æ–Ω–æ–º—ñ—è ~0.5W. –í–∏–º–∏–∫–∞–π—Ç–µ, —è–∫—â–æ Bluetooth –Ω–µ
                                    –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.</span>
                                <select id="POWER_SAVE_BLUETOOTH" name="POWER_SAVE_BLUETOOTH">
                                    <option value="false">–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
                                    <option value="true">–í–∏–º–∫–Ω–µ–Ω–æ</option>
                                </select>
                            </div>


                            <div
                                style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #17a2b2;">
                                <strong style="color: #0c5460;">üìä –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω:</strong>
                                <div style="margin-top: 8px; font-size: 13px; color: #0c5460;">
                                    <div>WiFi: <span id="currentWifiState">...</span></div>
                                    <div>Bluetooth: <span id="currentBluetoothState">...</span></div>
                                    <div>Ethernet: <span id="currentEthState">...</span></div>
                                </div>
                            </div>
                        </div>

                    </details>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
                        </button>
                    </div>
                </form>
            </div>

            <!-- Raw Config Tab Content -->
            <div id="rawTabContent" class="tab-content" style="display: none;">
                <div class="section-title">üìù –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É <span
                        style="font-size: 12px; color: #999;">(–¥–ª—è –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)</span></div>

                <div
                    style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ffc107;">
                    <strong style="color: #856404;">‚ö†Ô∏è –£–≤–∞–≥–∞:</strong>
                    <p style="margin: 8px 0 0 0; font-size: 13px; color: #856404;">
                        –ü—Ä—è–º–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É –¥–∞—î –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤—Å—ñ–º–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏,
                        –∞–ª–µ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø—Ä–æ–±–ª–µ–º –∑ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—é, —è–∫—â–æ –∑—Ä–æ–±–ª–µ–Ω–æ –ø–æ–º–∏–ª–∫–∏.
                        –ü–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É.
                    </p>
                </div>

                <div class="form-group">
                    <label for="rawConfigContent">–í–º—ñ—Å—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É:</label>
                    <span class="help-text">
                        –†–µ–¥–∞–≥—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –Ω–∞–ø—Ä—è–º—É. –ö–æ–∂–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –º–∞—î —Ñ–æ—Ä–º–∞—Ç: –ö–õ–Æ–ß=–ó–ù–ê–ß–ï–ù–ù–Ø
                    </span>
                    <textarea id="rawConfigContent" spellcheck="false" placeholder="# FORPOST Stream Configuration
# Example settings:
RTMP_URL=rtmps://server:port/app/key
OVERLAY_TEXT=My Drone
VIDEO_CRF=30"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="loadRawBtn">
                        üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
                    </button>
                    <button type="button" class="btn btn-primary" id="saveRawBtn">
                        üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª
                    </button>
                    <button type="button" class="btn btn-secondary" id="loadDefaultsBtn"
                        style="background: #17a2b8; color: white;">
                        üìã –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω + defaults
                    </button>
                </div>

                <div id="backupInfo" class="backup-info">
                    <strong>üì¶ –†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó (–æ—Å—Ç–∞–Ω–Ω—ñ 3):</strong>
                    <div id="backupList" style="margin-top: 8px;"></div>
                </div>

                <div id="rawEditorStatus"
                    style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px;"></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">üîß –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥—É–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è Dzyga:</div>

            <div
                style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ffc107;">
                <p style="margin: 8px 0 0 0; font-size: 13px; color: #856404;">
                    –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –º–æ–¥—É–ª—å –ø–æ—à—É–∫—É —á–∞—Å—Ç–æ—Ç. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º –¥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è, no
                    serial port, –∑–∞–≤–∏—Å–∞–Ω–Ω—ñ –µ–º—É–ª—è—Ü—ñ—ó –µ–∫—Ä–∞–Ω—É.
                </p>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" id="restartDzygaBtn"
                    style="background: #17a2b8; color: white;">
                    üîÑ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                </button>
            </div>

            <div id="dzygaRestartStatus"
                style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px;"></div>
        </div>        
        
        <div class="card">
            <div class="section-title"
                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                onclick="toggleFirmwareHelpSection()">
                <span>üìñ –î–æ–≤—ñ–¥–∫–∞: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Dzyga</span>
                <span id="firmwareHelpToggleIcon" style="font-size: 20px;">‚ñº</span>
            </div>

            <div id="firmwareHelpContent" style="display: none; margin-top: 12px; font-size: 14px; line-height: 1.6;">
                <p>–ü—Ä–æ–≥—Ä–∞–º–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è <strong>Dzyga Forpost</strong> —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –≤–∏—Ä–æ–±–Ω–∏–∫–∞ —Ç–∞ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å —Å–ø—ñ–ª—å–Ω–æ—Ç–∏. <strong>FORPOST Stream</strong> (—Ü—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞) ‚Äî —Å—Ç–æ—Ä–æ–Ω–Ω—î —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –¥–ª—è —Å—Ç—Ä—ñ–º—ñ–Ω–≥—É –≤—ñ–¥–µ–æ –≤ –î–µ–ª—å—Ç—É.</p>

                <p>–î–≤–∞ –±–ª–æ–∫–∏ –Ω–∏–∂—á–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—ñ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ <strong>—Å–∞–º–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é Dzyga</strong>, –Ω–∞–¥–∞–Ω–∏—Ö –≤–∏—Ä–æ–±–Ω–∏–∫–æ–º. –¶–µ –∑—Ä—É—á–Ω–∞ –æ–±–≥–æ—Ä—Ç–∫–∞, —â–æ –∑–º–µ–Ω—à—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π.</p>

                <div style="background: #fff3cd; padding: 10px 14px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #ffc107;">
                    <strong>–í–∞–∂–ª–∏–≤–æ:</strong> –æ–Ω–æ–≤–ª–µ–Ω–Ω—è FORPOST Stream —ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Dzyga ‚Äî —Ü–µ <strong>–Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏</strong>.
                </div>

                <p>–ü—Ä–∏—Å—Ç—Ä—ñ–π Dzyga –º–∞—î –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:</p>

                <div style="margin-left: 8px;">
                    <p><strong>1. –°–µ—Ä–≤—ñ—Å Dzyga</strong> (–±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª) ‚Äî –∫–µ—Ä—É—î —Ä–æ–±–æ—Ç–æ—é –ø—Ä–∏—Å—Ç—Ä–æ—é —á–µ—Ä–µ–∑ —Å–µ—Ä—ñ–π–Ω–∏–π –ø–æ—Ä—Ç: –ø–µ—Ä–µ–¥–∞—î —á–∞—Å—Ç–æ—Ç–∏, –∑—á–∏—Ç—É—î –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω, —Å–∏–º—É–ª—é—î –µ–∫—Ä–∞–Ω –∫–µ—Ä—É–≤–∞–Ω–Ω—è. <strong>–§–∞–π–ª –æ–¥–Ω–∞–∫–æ–≤–∏–π –¥–ª—è –≤—Å—ñ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</strong> ‚Äî –π–æ–≥–æ –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ —É –≤–∏—Ä–æ–±–Ω–∏–∫–∞ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–º—É –±–ª–æ—Ü—ñ –Ω–∏–∂—á–µ.</p>

                    <p><strong>2. –ü—Ä–æ—à–∏–≤–∫–∞ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞</strong> (—Ñ–∞–π–ª .uf2) ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –ª–æ–≥—ñ–∫—É –æ–±—Ä–æ–±–∫–∏ —Å–∏–≥–Ω–∞–ª—É: –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É —É –≤—ñ–¥–µ–æ, –∑—É–ø–∏–Ω–∫—É –Ω–∞ —á–∞—Å—Ç–æ—Ç—ñ –∑ –∞–∫—Ç–∏–≤–Ω–∏–º –≤—ñ–¥–µ–æ, –ø—Ä–æ–ø—É—Å–∫ –ø–æ—Ä–æ–∂–Ω—ñ—Ö —á–∞—Å—Ç–æ—Ç —Ç–æ—â–æ. <strong>–§–∞–π–ª –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é.</strong> –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º—Ç–µ –≤–∏—Ä–æ–±–Ω–∏–∫—É ID –ø—Ä–∏—Å—Ç—Ä–æ—é, —è–∫–∏–π –≤–∫–∞–∑–∞–Ω–æ –≤ —à–∞–ø—Ü—ñ —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏.</p>
                </div>
            </div>
        </div>

        <!-- Dzyga Binary Management -->
        <div class="card">
            <div class="section-title"
                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                onclick="toggleDzygaBinarySection()">
                <span>üì¶ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É Dzyga</span>
                <span id="dzygaBinaryToggleIcon" style="font-size: 20px;">‚ñº</span>
            </div>

            <div id="dzygaBinaryContent" style="display: none; margin-top: 12px;">
                <!-- Current binary info -->
                <div id="dzygaBinaryInfo"
                    style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #17a2b2;">
                    <strong style="color: #0c5460;">üìä –ü–æ—Ç–æ—á–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª:</strong>
                    <div style="margin-top: 8px; font-size: 13px; color: #0c5460;" id="dzygaBinaryDetails">
                        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                    </div>
                </div>

                <!-- Upload form -->
                <div class="form-group">
                    <label>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª dzyga:</label>
                    <input type="file" id="dzygaFileInput"
                        style="width: 100%; padding: 12px; border: 2px dashed #e0e0e0; border-radius: 8px; font-size: 14px; cursor: pointer; background: #f8f9fa;">
                </div>

                <div class="button-group" style="margin-top: 12px;">
                    <button type="button" class="btn btn-primary" id="dzygaUploadBtn" disabled>
                        üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏
                    </button>
                </div>

                <div id="dzygaUploadProgress" style="display: none; margin-top: 12px;">
                    <div style="background: #e9ecef; border-radius: 8px; overflow: hidden; height: 24px;">
                        <div id="dzygaProgressBar"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                        </div>
                    </div>
                </div>

                <div id="dzygaUploadStatus"
                    style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px;"></div>

                <!-- Backups list -->
                <div id="dzygaBackupsSection" style="margin-top: 20px; display: none;">
                    <div class="section-title" style="font-size: 15px;">üì¶ –†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É</div>
                    <div id="dzygaBackupsList"></div>
                </div>
            </div>
        </div>

        <!-- Firmware Flash -->
        <div class="card">
            <div class="section-title"
                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                onclick="toggleFirmwareSection()">
                <span>üîå –ü—Ä–æ—à–∏–≤–∫–∞ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ (RP2040)</span>
                <span id="firmwareToggleIcon" style="font-size: 20px;">‚ñº</span>
            </div>

            <div id="firmwareContent" style="display: none; margin-top: 12px;">
                <!-- Current firmware info -->
                <div id="firmwareInfo"
                    style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #17a2b2;">
                    <strong style="color: #0c5460;">üìä –ü–æ—Ç–æ—á–Ω–∞ –ø—Ä–æ—à–∏–≤–∫–∞:</strong>
                    <div style="margin-top: 8px; font-size: 13px; color: #0c5460;" id="firmwareDetails">
                        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                    </div>
                </div>

                <div
                    style="background: #f8d7da; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #dc3545;">
                    <strong style="color: #721c24;">‚ö†Ô∏è –£–≤–∞–≥–∞:</strong>
                    <span style="color: #721c24;"> –ü—Ä–æ—à–∏–≤–∫–∞ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ ‚Äî –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —Ñ–∞–π–ª .uf2 –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.</span>
                </div>

                <!-- Upload form -->
                <div class="form-group">
                    <label>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª –ø—Ä–æ—à–∏–≤–∫–∏ (.uf2):</label>
                    <input type="file" id="firmwareFileInput" accept=".uf2"
                        style="width: 100%; padding: 12px; border: 2px dashed #e0e0e0; border-radius: 8px; font-size: 14px; cursor: pointer; background: #f8f9fa;">
                </div>

                <div class="button-group" style="margin-top: 12px;">
                    <button type="button" class="btn btn-primary" id="firmwareFlashBtn" disabled
                        style="background: #dc3545;">
                        üîå –ü—Ä–æ—à–∏—Ç–∏ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä
                    </button>
                </div>

                <div id="firmwareProgress" style="display: none; margin-top: 12px;">
                    <div style="background: #e9ecef; border-radius: 8px; overflow: hidden; height: 24px;">
                        <div id="firmwareProgressBar"
                            style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                        </div>
                    </div>
                </div>

                <div id="firmwareStatus"
                    style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px;"></div>
            </div>
        </div>

    </div>

    <script>
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }


        function setOperationBadge(text) {
            const b = document.getElementById('operationBadge');
            if (!b) return;
            b.style.display = 'inline-block';
            b.textContent = text;
        }

        function clearOperationBadge() {
            const b = document.getElementById('operationBadge');
            if (!b) return;
            b.style.display = 'none';
            b.textContent = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function switchTab(tabName) {
            const formTab = document.getElementById('formTab');
            const rawTab = document.getElementById('rawTab');
            const formContent = document.getElementById('formTabContent');
            const rawContent = document.getElementById('rawTabContent');

            if (tabName === 'form') {
                formTab.classList.add('active');
                rawTab.classList.remove('active');
                formContent.style.display = 'block';
                rawContent.style.display = 'none';
            } else if (tabName === 'raw') {
                formTab.classList.remove('active');
                rawTab.classList.add('active');
                formContent.style.display = 'none';
                rawContent.style.display = 'block';

                // Load raw config when switching to raw tab
                loadRawConfig();
                loadBackups();
            }
        }

        function waitForDesiredActiveState(desiredActive, timeoutMs) {
            const startTs = Date.now();
            return new Promise((resolve, reject) => {
                const tick = () => {
                    fetch('/api/status')
                        .then(r => r.json())
                        .then(s => {
                            if ((s.active || false) === desiredActive) {
                                resolve(s);
                                return;
                            }
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        })
                        .catch(() => {
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        });
                };
                tick();
            });
        }

        function waitForRestart(timeoutMs) {
            const startTs = Date.now();
            let sawNonActive = false;
            return new Promise((resolve, reject) => {
                const tick = () => {
                    fetch('/api/status')
                        .then(r => r.json())
                        .then(s => {
                            const status = (s.status || '').trim();
                            if (status && status !== 'active') {
                                sawNonActive = true;
                            }
                            if (sawNonActive && status === 'active') {
                                resolve(s);
                                return;
                            }
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        })
                        .catch(() => {
                            if (Date.now() - startTs >= timeoutMs) {
                                reject(new Error('TIMEOUT'));
                                return;
                            }
                            setTimeout(tick, 1000);
                        });
                };
                tick();
            });
        }

        function updateCpuModeBadge(config) {
            const badge = document.getElementById('cpuModeBadge');
            const overlayEnabled = config.OVERLAY_ENABLED === 'true';

            if (overlayEnabled) {
                badge.className = 'cpu-mode-badge cpu-high';
                badge.textContent = '‚ö° –ü–µ—Ä–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è';
            } else {
                badge.className = 'cpu-mode-badge cpu-low';
                badge.textContent = '‚ú® –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è';
            }
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    const config = data.config;
                    for (const [key, value] of Object.entries(config)) {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = value;
                        }
                    }
                    updateCpuModeBadge(config);
                    updateOverlayUI(config);
                })
                .catch(err => {
                    showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ' + err.message, 'error');
                });
        }

        function updateOverlayUI(config) {
            // Show/hide overlay options section based on OVERLAY_ENABLED
            const overlayEnabled = config.OVERLAY_ENABLED === 'true';
            const overlayOptionsSection = document.getElementById('overlayOptionsSection');
            if (overlayOptionsSection) {
                overlayOptionsSection.style.display = overlayEnabled ? 'block' : 'none';
            }

            const borderWidth = parseInt(config.DYNAMIC_OVERLAY_BORDER_WIDTH);
            const bgGroup = document.getElementById('dynamicBgGroup');
            const borderGroup = document.getElementById('dynamicBorderGroup');
            if (bgGroup && borderGroup) {
                if (borderWidth > 0) {
                    bgGroup.style.display = 'none';
                    borderGroup.style.display = 'block';
                } else {
                    bgGroup.style.display = 'block';
                    borderGroup.style.display = 'none';
                }
            }
        }

        let lastScanningState = 'stable';
        let isTextSaved = true;  // Track if current text in input is saved to server
        let lastSavedText = '';  // Track what was last saved

        function loadDynamicOverlayText() {
            fetch('/api/dynamic-overlay')
                .then(response => response.json())
                .then(data => {
                    const currentText = document.getElementById('currentDynamicText');
                    const textInput = document.getElementById('dynamicOverlayText');
                    const clearButton = document.getElementById('clearDynamicText');
                    const scanningIndicator = document.getElementById('scanningIndicator');
                    const scanningText = document.getElementById('scanningText');

                    // Always update display text with server value
                    if (currentText) {
                        currentText.textContent = data.text || '‚Äî';
                    }

                    // Update scanning status indicator
                    const isScanning = data.scanning === 'scanning';
                    if (scanningIndicator && scanningText) {
                        if (isScanning) {
                            scanningIndicator.style.background = '#ffc107';
                            scanningText.style.color = '#ffc107';
                            scanningText.textContent = 'üîç –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
                        } else {
                            scanningIndicator.style.background = '#28a745';
                            scanningText.style.color = '#28a745';
                            scanningText.textContent = '‚úì –ß–∞—Å—Ç–æ—Ç–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–∞';
                        }
                    }

                    // Clear input only when:
                    // 1. Transitioning from stable to scanning
                    // 2. AND text was previously saved (not being edited)
                    if (lastScanningState === 'stable' && isScanning && isTextSaved) {
                        if (textInput) {
                            textInput.value = '';
                            lastSavedText = '';
                        }
                        if (clearButton) {
                            clearButton.style.display = 'none';
                        }
                    }

                    lastScanningState = data.scanning || 'stable';

                    // Update clear button visibility
                    if (clearButton && textInput) {
                        clearButton.style.display = textInput.value ? 'block' : 'none';
                    }
                })
                .catch(err => console.error('Failed to load dynamic overlay text:', err));
        }

        function saveDynamicOverlayText(text) {
            const isScanning = lastScanningState === 'scanning';
            // If scanning, show visual feedback and don't save
            if (isScanning) {
                const textInput = document.getElementById('dynamicOverlayText');
                if (textInput) {
                    // Blink effect
                    textInput.style.animation = 'none';
                    setTimeout(() => {
                        textInput.style.animation = 'blink-red 0.5s';
                    }, 10);
                }
                return;
            }

            fetch('/api/dynamic-overlay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Dynamic overlay text updated');
                        isTextSaved = true;
                        lastSavedText = text;
                        // Reload to show current text
                        loadDynamicOverlayText();
                    }
                })
                .catch(err => console.error('Failed to save dynamic overlay text:', err));
        }

        document.getElementById('configForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const config = {};
            for (const [key, value] of formData.entries()) {
                config[key] = value;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

            fetch('/api/status')
                .then(r => r.json())
                .then(statusBefore => {
                    const wasActive = statusBefore.active || false;

                    return fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showAlert('‚úÖ ' + data.message, 'success');
                                loadConfig();

                                if (wasActive && data.stream_restart_required) {
                                    setOperationBadge('‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Ä¶');
                                    const minVisibleMs = 1500;
                                    const startedAt = Date.now();
                                    return waitForRestart(25000)
                                        .catch(() => null)
                                        .then(() => updatePowerStatus())
                                        .finally(() => {
                                            const elapsed = Date.now() - startedAt;
                                            const remaining = Math.max(0, minVisibleMs - elapsed);
                                            setTimeout(() => {
                                                clearOperationBadge();
                                            }, remaining);
                                        });
                                } else {
                                    // Update power status immediately if stream is not active or no restart needed
                                    setTimeout(() => updatePowerStatus(), 2000);
                                }
                            } else {
                                showAlert('‚ùå ' + data.error, 'error');
                            }
                        });
                })
                .catch(err => {
                    showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é';
                });
        });

        // Start stream button
        document.getElementById('startBtn').addEventListener('click', function () {
            const btn = this;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';
            setOperationBadge('‚è≥ –ó–∞–ø—É—Å–∫‚Ä¶');

            fetch('/api/stream/start', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('‚úÖ ' + data.message, 'success');
                        return waitForDesiredActiveState(true, 20000)
                            .then(() => {
                                clearOperationBadge();
                                updatePowerStatus();
                            })
                            .catch(() => {
                                clearOperationBadge();
                                updatePowerStatus();
                            });
                    } else {
                        showAlert('‚ùå ' + data.error, 'error');
                        clearOperationBadge();
                    }
                })
                .catch(err => {
                    showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                    clearOperationBadge();
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        });

        // Stop stream button
        document.getElementById('stopBtn').addEventListener('click', function () {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑—É–ø–∏–Ω–∏—Ç–∏ —Å—Ç—Ä—ñ–º?')) {
                return;
            }

            const btn = this;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ó—É–ø–∏–Ω–∫–∞...';
            setOperationBadge('‚è≥ –ó—É–ø–∏–Ω–∫–∞‚Ä¶');

            fetch('/api/stream/stop', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('‚úÖ ' + data.message, 'success');
                        return waitForDesiredActiveState(false, 20000)
                            .then(() => {
                                clearOperationBadge();
                                updatePowerStatus();
                            })
                            .catch(() => {
                                clearOperationBadge();
                                updatePowerStatus();
                            });
                    } else {
                        showAlert('‚ùå ' + data.error, 'error');
                        clearOperationBadge();
                    }
                })
                .catch(err => {
                    showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                    clearOperationBadge();
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        });

        // Restart stream button
        document.getElementById('restartStreamBtn').addEventListener('click', function () {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç—Ä—ñ–º?')) {
                return;
            }

            const btn = this;
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...';
            setOperationBadge('‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Ä¶');


            fetch('/api/stream/restart', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('‚úÖ ' + data.message, 'success');
                        return waitForDesiredActiveState(true, 25000)
                            .then(() => {
                                clearOperationBadge();
                                updatePowerStatus();
                            })
                            .catch(() => {
                                clearOperationBadge();
                                updatePowerStatus();
                            });
                    } else {
                        showAlert('‚ùå ' + data.error, 'error');
                        clearOperationBadge();
                    }
                })
                .catch(err => {
                    showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                    clearOperationBadge();
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        });

        // Restart Dzyga button
        document.getElementById('restartDzygaBtn').addEventListener('click', function () {
            if (!confirm('–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Dzyga —Å–µ—Ä–≤—ñ—Å? –¶–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–¥—É–ª—å –ø–æ—à—É–∫—É —á–∞—Å—Ç–æ—Ç.')) {
                return;
            }

            const btn = this;
            const statusDiv = document.getElementById('dzygaRestartStatus');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...';

            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.textContent = '‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Dzyga —Å–µ—Ä–≤—ñ—Å–∞...';

            fetch('/api/restart-dzyga', {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                        statusDiv.textContent = '‚úÖ ' + data.message;
                        showAlert('‚úÖ ' + data.message, 'success');
                    } else {
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.textContent = '‚ùå ' + data.error;
                        showAlert('‚ùå ' + data.error, 'error');
                    }

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 10000);
                })
                .catch(err => {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message;
                    showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 10000);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        });

        function checkUpdates(force = false) {
            const channel = document.getElementById('updateChannel').value;
            const forceParam = force ? '&force=1' : '';

            fetch(`/api/updates/check?channel=${channel}${forceParam}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Update check failed:', data.error);
                        return;
                    }

                    document.getElementById('currentVersion').textContent = data.current;
                    document.getElementById('currentVersionBadge').textContent = data.current;

                    // Show update available banner and badge
                    const newVersionBadge = document.getElementById('newVersionBadge');
                    if (data.has_update) {
                        document.getElementById('latestVersion').textContent = data.latest;
                        document.getElementById('updateAvailable').style.display = 'block';
                        newVersionBadge.style.display = 'inline-block';
                    } else {
                        document.getElementById('updateAvailable').style.display = 'none';
                        newVersionBadge.style.display = 'none';
                    }

                    // Build releases list
                    const updatesList = document.getElementById('updatesList');
                    updatesList.innerHTML = '';

                    if (data.releases && data.releases.length > 0) {
                        data.releases.forEach(release => {
                            // Check if this is the current version
                            // For master, compare directly; for releases, compare with 'v' prefix
                            const isCurrent = (release.version === 'master' && data.current === 'master') ||
                                            (release.version === `v${data.current}`) ||
                                            (release.version === data.current);
                            
                            const releaseDiv = document.createElement('div');
                            releaseDiv.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;';

                            let badge = '';
                            if (isCurrent) {
                                badge = '<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">–ü–û–¢–û–ß–ù–ê</span>';
                            } else if (release.version === 'master') {
                                badge = '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">LATEST</span>';
                            } else if (release.prerelease) {
                                badge = '<span style="background: #ffc107; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">BETA</span>';
                            }

                            // Special styling for master branch
                            const titleText = release.version === 'master' ? 
                                `<strong style="color: #28a745;">${release.name || release.version}</strong>` : 
                                `<strong>${release.version}</strong>`;

                            releaseDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        ${titleText}
                                        ${badge}
                                    </div>
                                    <div>
                                        ${isCurrent ? '' : `<button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="installUpdate('${release.version}')">–û–Ω–æ–≤–∏—Ç–∏</button>`}
                                    </div>
                                </div>
                                ${release.body ? `<div style="font-size: 12px; color: #666; white-space: pre-wrap;">${release.body.substring(0, 200)}${release.body.length > 200 ? '...' : ''}</div>` : ''}
                            `;

                            updatesList.appendChild(releaseDiv);
                        });
                    } else {
                        updatesList.innerHTML = '<p style="color: #666;">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å</p>';
                    }
                })
                .catch(err => {
                    console.error('Failed to check updates:', err);
                });
        }
        function forceCheckUpdates() {
            checkUpdates(true);
        }
        
        function installUpdate(version) {
            if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ –¥–æ –≤–µ—Ä—Å—ñ—ó ${version}?`)) {
                return;
            }

            const overlay = document.getElementById('updateOverlay');
            const message = document.getElementById('updateMessage');

            overlay.classList.add('show');
            message.textContent = '–ó–∞–ø—É—Å–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è...';

            fetch('/api/updates/install', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ version: version })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        message.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è... –ó–∞—á–µ–∫–∞–π—Ç–µ 35 —Å–µ–∫—É–Ω–¥...';

                        // Simple approach: wait 35 seconds and reload
                        // This is more reliable than polling
                        setTimeout(() => {
                            message.textContent = '‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                            setTimeout(() => {
                                location.reload(true);
                            }, 1000);
                        }, 35000);
                    } else {
                        overlay.classList.remove('show');
                        showAlert('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞'), 'error');
                    }
                })
                .catch(err => {
                    overlay.classList.remove('show');
                    showAlert('‚ùå ' + err.message, 'error');
                });
        }



        function toggleUpdateSection() {
            const content = document.getElementById('updateContent');
            const icon = document.getElementById('updateToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function toggleStaticOverlay() {
            const content = document.getElementById('staticOverlaySection');
            const icon = document.getElementById('staticOverlayIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function toggleStaticSettings() {
            const content = document.getElementById('staticSettings');
            const icon = document.getElementById('staticSettingsIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function toggleFrequencyOverlay() {
            const content = document.getElementById('frequencyOverlaySection');
            const icon = document.getElementById('frequencyOverlayIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function toggleDynamicOverlay() {
            const content = document.getElementById('dynamicOverlaySection');
            const icon = document.getElementById('dynamicOverlayIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function toggleFrequencySettings() {
            const content = document.getElementById('frequencySettings');
            const icon = document.getElementById('frequencySettingsIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function toggleDynamicOverlaySettings() {
            const content = document.getElementById('dynamicOverlaySettings');
            const icon = document.getElementById('dynamicOverlaySettingsIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function updatePowerStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update status badge
                    const badge = document.getElementById('statusBadge');
                    if (data.active) {
                        badge.className = 'status-badge status-active';
                        badge.textContent = '‚óè –ê–∫—Ç–∏–≤–Ω–∏–π';
                    } else {
                        badge.className = 'status-badge status-inactive';
                        badge.textContent = '‚óè –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π';
                    }

                    // Update power state
                    const power = data.power || {};
                    document.getElementById('currentWifiState').textContent = power.wifi || '‚Äî';
                    document.getElementById('currentBluetoothState').textContent = power.bluetooth || '‚Äî';
                    document.getElementById('currentEthState').textContent = power.ethernet || '‚Äî';
                })
                .catch(err => {
                    console.error('Failed to load status:', err);
                });
        }

        // Update channel change handler
        document.getElementById('updateChannel').addEventListener('change', checkUpdates);

        // Dynamic overlay text input handlers
        const dynamicOverlayInput = document.getElementById('dynamicOverlayText');
        const clearButton = document.getElementById('clearDynamicText');

        if (dynamicOverlayInput) {
            // Show/hide clear button based on input content
            const updateClearButton = () => {
                if (clearButton) {
                    clearButton.style.display = dynamicOverlayInput.value ? 'block' : 'none';
                }
            };

            // Mark text as unsaved when user types
            dynamicOverlayInput.addEventListener('input', function () {
                isTextSaved = (this.value === lastSavedText);
                updateClearButton();
            });

            // Save on Enter key
            dynamicOverlayInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveDynamicOverlayText(this.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    this.value = '';
                    isTextSaved = true;
                    lastSavedText = '';
                    updateClearButton();
                    saveDynamicOverlayText('');
                }
            });
        }

        // Clear button handler
        if (clearButton) {
            clearButton.addEventListener('click', function () {
                dynamicOverlayInput.value = '';
                clearButton.style.display = 'none';
                isTextSaved = true;
                lastSavedText = '';
                saveDynamicOverlayText('');
                dynamicOverlayInput.focus();
            });
        }

        // Overlay enabled toggle
        const overlayEnabledSelect = document.getElementById('OVERLAY_ENABLED');
        if (overlayEnabledSelect) {
            overlayEnabledSelect.addEventListener('change', function () {
                const config = { OVERLAY_ENABLED: this.value };
                updateOverlayUI(config);
                updateCpuModeBadge(config);
            });
        }

        // Static overlay border width toggle
        const staticBorderWidthInput = document.getElementById('OVERLAY_BORDER_WIDTH');
        if (staticBorderWidthInput) {
            staticBorderWidthInput.addEventListener('change', function () {
                const borderWidth = parseInt(this.value || 0);
                const bgGroup = document.getElementById('staticBgGroup');
                const borderGroup = document.getElementById('staticBorderGroup');
                if (bgGroup && borderGroup) {
                    if (borderWidth > 0) {
                        bgGroup.style.display = 'none';
                        borderGroup.style.display = 'block';
                    } else {
                        bgGroup.style.display = 'block';
                        borderGroup.style.display = 'none';
                    }
                }
            });
        }

        // Frequency border width toggle
        const freqBorderWidthInput = document.getElementById('FREQUENCY_BORDER_WIDTH');
        if (freqBorderWidthInput) {
            freqBorderWidthInput.addEventListener('change', function () {
                const borderWidth = parseInt(this.value || 0);
                const bgGroup = document.getElementById('frequencyBgGroup');
                const borderGroup = document.getElementById('frequencyBorderGroup');
                if (bgGroup && borderGroup) {
                    if (borderWidth > 0) {
                        bgGroup.style.display = 'none';
                        borderGroup.style.display = 'block';
                    } else {
                        bgGroup.style.display = 'block';
                        borderGroup.style.display = 'none';
                    }
                }
            });
        }

        // Dynamic overlay border width toggle
        const borderWidthInput = document.getElementById('DYNAMIC_OVERLAY_BORDER_WIDTH');
        if (borderWidthInput) {
            borderWidthInput.addEventListener('change', function () {
                const borderWidth = parseInt(this.value || 0);
                const bgGroup = document.getElementById('dynamicBgGroup');
                const borderGroup = document.getElementById('dynamicBorderGroup');
                if (bgGroup && borderGroup) {
                    if (borderWidth > 0) {
                        bgGroup.style.display = 'none';
                        borderGroup.style.display = 'block';
                    } else {
                        bgGroup.style.display = 'block';
                        borderGroup.style.display = 'none';
                    }
                }
            });
        }

        loadConfig();
        updatePowerStatus();
        checkUpdates();

        // Load dynamic overlay text on page load
        setTimeout(() => {
            loadDynamicOverlayText();
        }, 500);

        // Poll dynamic overlay text every 3 seconds to sync with server
        // This clears the input field when frequency changes >10 MHz
        setInterval(loadDynamicOverlayText, 3000);

        setInterval(updatePowerStatus, 10000);
        setInterval(checkUpdates, 300000); // Check updates every 5 minutes

        // Update power status when advanced settings is opened
        document.querySelector('details').addEventListener('toggle', function (e) {
            if (this.open) {
                updatePowerStatus();
            }
        });

        // Raw configuration editor functions
        function toggleRawEditor() {
            const section = document.getElementById('rawEditorSection');
            const icon = document.getElementById('rawEditorIcon');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñ≤';
                // Auto-load current config when opening
                loadRawConfig();
                loadBackups();
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function loadBackups() {
            const backupInfo = document.getElementById('backupInfo');
            const backupList = document.getElementById('backupList');

            fetch('/api/config/backups')
                .then(response => response.json())
                .then(data => {
                    if (data.backups && data.backups.length > 0) {
                        backupInfo.style.display = 'block';
                        backupList.innerHTML = '';

                        data.backups.forEach(backup => {
                            const backupDiv = document.createElement('div');
                            backupDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 4px; background: white; border: 1px solid #ddd; border-radius: 4px;';

                            backupDiv.innerHTML = `
                                <span style="font-size: 12px;">
                                    <strong>–ë–µ–∫–∞–ø ${backup.number}:</strong> ${backup.modified}
                                </span>
                                <div style="display: flex; gap: 4px;">
                                    <button type="button" onclick="viewBackup(${backup.number})" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        üëÅÔ∏è
                                    </button>
                                    <button type="button" onclick="restoreBackup(${backup.number})" style="font-size: 11px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        üîÑ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏
                                    </button>
                                </div>
                            `;

                            backupList.appendChild(backupDiv);
                        });
                    } else {
                        backupInfo.style.display = 'block';
                        backupList.innerHTML = '<span style="font-size: 12px; color: #666;">–†–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>';
                    }
                })
                .catch(err => {
                    console.error('Failed to load backups:', err);
                    backupInfo.style.display = 'none';
                });
        }

        function viewBackup(backupNum) {
            fetch(`/api/config/backup/${backupNum}`)
                .then(response => response.json())
                .then(data => {
                    if (data.content) {
                        const textarea = document.getElementById('rawConfigContent');
                        textarea.value = data.content;
                        showRawEditorStatus(`‚úÖ –ë–µ–∫–∞–ø ${backupNum} –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä`, 'success');
                    } else if (data.error) {
                        showRawEditorStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${data.error}`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to load backup:', err);
                    showRawEditorStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∫–∞–ø—É', 'error');
                });
        }

        function restoreBackup(backupNum) {
            if (!confirm(`‚ö†Ô∏è –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –±–µ–∫–∞–ø—É ${backupNum} –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ –ø–æ—Ç–æ—á–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é.\n\n–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è?`)) {
                return;
            }

            fetch(`/api/config/restore/${backupNum}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showRawEditorStatus(`‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∑ –±–µ–∫–∞–ø—É ${backupNum}`, 'success');
                        // Reload the editor content and form data
                        setTimeout(() => {
                            loadRawConfig();
                            loadConfig();
                            loadBackups();
                        }, 1000);
                    } else {
                        showRawEditorStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è: ${data.error}`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to restore backup:', err);
                    showRawEditorStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó', 'error');
                });
        }

        function loadDefaults() {
            fetch('/api/config/defaults')
                .then(response => response.json())
                .then(data => {
                    if (data.content) {
                        const textarea = document.getElementById('rawConfigContent');
                        textarea.value = data.content;
                        showRawEditorStatus('‚úÖ –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ defaults –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', 'success');
                    } else if (data.error) {
                        showRawEditorStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É: ${data.error}`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to load defaults:', err);
                    showRawEditorStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É', 'error');
                });
        }

        function loadRawConfig() {
            const textarea = document.getElementById('rawConfigContent');
            const loadBtn = document.getElementById('loadRawBtn');
            const statusDiv = document.getElementById('rawEditorStatus');

            if (!textarea || !loadBtn) return;

            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            statusDiv.style.display = 'none';

            fetch('/api/config/raw')
                .then(response => response.json())
                .then(data => {
                    if (data.content) {
                        textarea.value = data.content;
                        showRawEditorStatus('‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ', 'success');
                    } else if (data.error) {
                        showRawEditorStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${data.error}`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to load raw config:', err);
                    showRawEditorStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó', 'error');
                })
                .finally(() => {
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é';
                });
        }

        function saveRawConfig() {
            const textarea = document.getElementById('rawConfigContent');
            const saveBtn = document.getElementById('saveRawBtn');
            const content = textarea.value.trim();

            if (!textarea || !saveBtn) return;

            if (!content) {
                showRawEditorStatus('‚ùå –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º', 'error');
                return;
            }

            // Basic validation
            const lines = content.split('\n');
            const invalidLines = lines.filter(line => {
                const trimmed = line.trim();
                return trimmed && !trimmed.startsWith('#') && !trimmed.includes('=') && trimmed !== '';
            });

            if (invalidLines.length > 0) {
                showRawEditorStatus(`‚ùå –ó–Ω–∞–π–¥–µ–Ω–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ —Ä—è–¥–∫–∏: ${invalidLines.slice(0, 3).join(', ')}${invalidLines.length > 3 ? '...' : ''}`, 'error');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

            fetch('/api/config/raw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: content })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showRawEditorStatus('‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ. –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é.', 'success');
                        // Reload form data and backups
                        setTimeout(() => {
                            loadConfig();
                            loadBackups();
                        }, 1000);
                    } else {
                        showRawEditorStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${data.error}`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to save raw config:', err);
                    showRawEditorStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó', 'error');
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª';
                });
        }

        function showRawEditorStatus(message, type) {
            const statusDiv = document.getElementById('rawEditorStatus');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            }

            // Auto-hide after 10 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 10000);
        }

        // Raw editor event listeners
        document.getElementById('loadRawBtn').addEventListener('click', loadRawConfig);
        document.getElementById('saveRawBtn').addEventListener('click', saveRawConfig);
        document.getElementById('loadDefaultsBtn').addEventListener('click', loadDefaults);

        // Add keyboard shortcuts for raw editor
        const rawTextarea = document.getElementById('rawConfigContent');
        if (rawTextarea) {
            rawTextarea.addEventListener('keydown', function (e) {
                // Ctrl+S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveRawConfig();
                }
                // Ctrl+L to load
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    loadRawConfig();
                }
                // Tab support
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                }
            });
        }
        // --- Dzyga Binary Management ---

        function toggleDzygaBinarySection() {
            const content = document.getElementById('dzygaBinaryContent');
            const icon = document.getElementById('dzygaBinaryToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                loadDzygaBinaryInfo();
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function loadDzygaBinaryInfo() {
            const details = document.getElementById('dzygaBinaryDetails');
            fetch('/api/dzyga/info')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        details.innerHTML = '<span style="color: #721c24;">–ü–æ–º–∏–ª–∫–∞: ' + data.error + '</span>';
                        return;
                    }

                    if (!data.binary_exists) {
                        details.innerHTML = '<span style="color: #856404;">–ë—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>';
                    } else {
                        details.innerHTML =
                            '<div>–†–æ–∑–º—ñ—Ä: <strong>' + formatFileSize(data.size) + '</strong></div>' +
                            '<div>MD5: <strong><code>' + data.md5 + '</code></strong></div>' +
                            '<div>–ó–º—ñ–Ω–µ–Ω–æ: <strong>' + data.modified + '</strong></div>' +
                            '<div>–°–µ—Ä–≤—ñ—Å: <strong>' + (data.service_status || 'unknown') + '</strong></div>';
                    }

                    // Render backups
                    const backupsSection = document.getElementById('dzygaBackupsSection');
                    const backupsList = document.getElementById('dzygaBackupsList');

                    if (data.backups && data.backups.length > 0) {
                        backupsSection.style.display = 'block';
                        backupsList.innerHTML = '';

                        data.backups.forEach(function (backup) {
                            const div = document.createElement('div');
                            div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 6px; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; flex-wrap: wrap; gap: 8px;';

                            // Extract md5 from filename for display
                            const md5Match = backup.filename.match(/md5_([a-f0-9]+)$/);
                            const md5Short = md5Match ? md5Match[1].substring(0, 8) + '...' : '';

                            div.innerHTML =
                                '<div style="font-size: 12px; min-width: 200px;">' +
                                    '<div><strong>' + backup.filename + '</strong></div>' +
                                    '<div style="color: #666;">' + formatFileSize(backup.size) + ' | ' + backup.modified +
                                    (md5Short ? ' | MD5: <code>' + md5Short + '</code>' : '') +
                                    '</div>' +
                                '</div>' +
                                '<div style="display: flex; gap: 6px;">' +
                                    '<button type="button" onclick="restoreDzygaBackup(\'' + backup.filename + '\')" ' +
                                        'style="font-size: 12px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">' +
                                        'üîÑ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏</button>' +
                                    '<button type="button" onclick="deleteDzygaBackup(\'' + backup.filename + '\')" ' +
                                        'style="font-size: 12px; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">' +
                                        'üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>' +
                                '</div>';

                            backupsList.appendChild(div);
                        });
                    } else {
                        backupsSection.style.display = 'block';
                        backupsList.innerHTML = '<span style="font-size: 13px; color: #666;">–†–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–ø—ñ–π –Ω–µ–º–∞—î</span>';
                    }
                })
                .catch(function (err) {
                    details.innerHTML = '<span style="color: #721c24;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + err.message + '</span>';
                });
        }

        // Enable upload button when file is selected
        document.getElementById('dzygaFileInput').addEventListener('change', function () {
            document.getElementById('dzygaUploadBtn').disabled = !this.files.length;
        });

        // Upload dzyga binary
        document.getElementById('dzygaUploadBtn').addEventListener('click', function () {
            const fileInput = document.getElementById('dzygaFileInput');
            if (!fileInput.files.length) return;

            if (!confirm('‚ö†Ô∏è –¶–µ –∑—É–ø–∏–Ω–∏—Ç—å —Å–µ—Ä–≤—ñ—Å Dzyga, –∑–∞–º—ñ–Ω–∏—Ç—å –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤—ñ—Å.\n\n–ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª –±—É–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —è–∫ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é.\n\n–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
                return;
            }

            const btn = this;
            const statusDiv = document.getElementById('dzygaUploadStatus');
            const progressDiv = document.getElementById('dzygaUploadProgress');
            const progressBar = document.getElementById('dzygaProgressBar');

            btn.disabled = true;
            btn.textContent = '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '';
            statusDiv.style.display = 'none';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/dzyga/upload');

            xhr.upload.addEventListener('progress', function (e) {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = pct + '%';
                    progressBar.textContent = pct + '%';
                }
            });

            xhr.addEventListener('load', function () {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        showDzygaStatus('‚úÖ ' + data.message +
                            (data.backup ? ' (–±–µ–∫–∞–ø: ' + data.backup + ')' : '') +
                            ' | MD5: ' + data.new_md5, 'success');
                        showAlert('‚úÖ ' + data.message, 'success');
                        fileInput.value = '';
                        btn.disabled = true;
                        loadDzygaBinaryInfo();
                    } else {
                        showDzygaStatus('‚ùå ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'), 'error');
                        showAlert('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'), 'error');
                    }
                } catch (e) {
                    showDzygaStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                }

                setTimeout(function () { progressDiv.style.display = 'none'; }, 3000);
                btn.disabled = false;
                btn.textContent = 'üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏';
            });

            xhr.addEventListener('error', function () {
                showDzygaStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                progressDiv.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏';
            });

            xhr.send(formData);
        });

        function showDzygaStatus(message, type) {
            const statusDiv = document.getElementById('dzygaUploadStatus');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            }
            setTimeout(function () { statusDiv.style.display = 'none'; }, 15000);
        }

        function restoreDzygaBackup(filename) {
            if (!confirm('‚ö†Ô∏è –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª dzyga –∑ –±–µ–∫–∞–ø—É?\n\n' + filename + '\n\n–°–µ—Ä–≤—ñ—Å –±—É–¥–µ –∑—É–ø–∏–Ω–µ–Ω–æ —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ.')) {
                return;
            }

            showDzygaStatus('‚è≥ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –±–µ–∫–∞–ø—É...', 'success');

            fetch('/api/dzyga/restore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.success) {
                        showDzygaStatus('‚úÖ ' + data.message + ' | MD5: ' + data.md5, 'success');
                        showAlert('‚úÖ ' + data.message, 'success');
                        loadDzygaBinaryInfo();
                    } else {
                        showDzygaStatus('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è'), 'error');
                        showAlert('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è'), 'error');
                    }
                })
                .catch(function (err) {
                    showDzygaStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                });
        }

        function deleteDzygaBackup(filename) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é?\n\n' + filename)) {
                return;
            }

            fetch('/api/dzyga/backup/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.success) {
                        showDzygaStatus('‚úÖ ' + data.message, 'success');
                        loadDzygaBinaryInfo();
                    } else {
                        showDzygaStatus('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è'), 'error');
                    }
                })
                .catch(function (err) {
                    showDzygaStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
                });
        }

        // --- Firmware Help Section ---

        function toggleFirmwareHelpSection() {
            var content = document.getElementById('firmwareHelpContent');
            var icon = document.getElementById('firmwareHelpToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // --- Firmware (RP2040) Management ---

        function toggleFirmwareSection() {
            var content = document.getElementById('firmwareContent');
            var icon = document.getElementById('firmwareToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                loadFirmwareInfo();
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function loadFirmwareInfo() {
            var details = document.getElementById('firmwareDetails');
            fetch('/api/firmware/info')
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.error) {
                        details.innerHTML = '<span style="color: #721c24;">–ü–æ–º–∏–ª–∫–∞: ' + data.error + '</span>';
                        return;
                    }
                    details.innerHTML =
                        '<div>ID: <strong><code>' + (data.serial || '–Ω–µ–≤—ñ–¥–æ–º–æ') + '</code></strong></div>' +
                        '<div>–ü—Ä–∏—Å—Ç—Ä—ñ–π: <strong>' + (data.device_present ? '‚úÖ /dev/rp2040 –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ' : '‚ùå /dev/rp2040 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ') + '</strong></div>';
                })
                .catch(function (err) {
                    details.innerHTML = '<span style="color: #721c24;">–ü–æ–º–∏–ª–∫–∞: ' + err.message + '</span>';
                });
        }

        function showFirmwareStatus(message, type) {
            var statusDiv = document.getElementById('firmwareStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            }
        }

        document.getElementById('firmwareFileInput').addEventListener('change', function () {
            var btn = document.getElementById('firmwareFlashBtn');
            btn.disabled = !this.files.length;
        });

        var firmwareSteps = [
            { pct: 10, text: 'üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª...', delay: 0 },
            { pct: 20, text: 'üõë –ó—É–ø–∏–Ω–∫–∞ dzyga —Å–µ—Ä–≤—ñ—Å–∞...', delay: 1500 },
            { pct: 30, text: 'üîå –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è RP2040 –≤ —Ä–µ–∂–∏–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...', delay: 3000 },
            { pct: 45, text: '‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ—è–≤–∏ USB –¥–∏—Å–∫–∞...', delay: 5000 },
            { pct: 55, text: '‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ—è–≤–∏ USB –¥–∏—Å–∫–∞...', delay: 8000 },
            { pct: 65, text: 'üíæ –ú–æ–Ω—Ç—É–≤–∞–Ω–Ω—è –¥–∏—Å–∫–∞...', delay: 11000 },
            { pct: 75, text: 'üìù –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏...', delay: 13000 },
            { pct: 85, text: 'üîÑ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞...', delay: 16000 },
            { pct: 92, text: '‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è /dev/rp2040...', delay: 19000 },
            { pct: 96, text: 'üöÄ –ó–∞–ø—É—Å–∫ dzyga —Å–µ—Ä–≤—ñ—Å–∞...', delay: 22000 }
        ];
        var firmwareStepTimers = [];

        document.getElementById('firmwareFlashBtn').addEventListener('click', function () {
            var fileInput = document.getElementById('firmwareFileInput');
            if (!fileInput.files.length) return;

            var file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.uf2')) {
                showFirmwareStatus('‚ùå –î–æ–∑–≤–æ–ª–µ–Ω—ñ –ª–∏—à–µ .uf2 —Ñ–∞–π–ª–∏', 'error');
                return;
            }

            if (!confirm('–ü—Ä–æ—à–∏—Ç–∏ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä —Ñ–∞–π–ª–æ–º:\n\n' + file.name + '\n\n–¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
                return;
            }

            var btn = this;
            btn.disabled = true;
            var originalText = btn.textContent;
            btn.textContent = '‚è≥ –ü—Ä–æ—à–∏–≤–∫–∞...';

            var progressDiv = document.getElementById('firmwareProgress');
            var progressBar = document.getElementById('firmwareProgressBar');
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '';

            showFirmwareStatus('‚è≥ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –ø—Ä–æ—à–∏–≤–∫–∏...', 'info');

            // Start step animation
            firmwareStepTimers.forEach(function (t) { clearTimeout(t); });
            firmwareStepTimers = [];
            firmwareSteps.forEach(function (step) {
                var t = setTimeout(function () {
                    progressBar.style.width = step.pct + '%';
                    progressBar.textContent = step.pct + '%';
                    showFirmwareStatus(step.text, 'info');
                }, step.delay);
                firmwareStepTimers.push(t);
            });

            var formData = new FormData();
            formData.append('file', file);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/firmware/flash', true);

            xhr.onload = function () {
                firmwareStepTimers.forEach(function (t) { clearTimeout(t); });
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        showFirmwareStatus('‚úÖ ' + data.message, 'success');
                    } else {
                        showFirmwareStatus('‚ùå ' + (data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏'), 'error');
                    }
                } catch (e) {
                    showFirmwareStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ', 'error');
                }

                btn.disabled = true;
                btn.textContent = originalText;
                fileInput.value = '';
            };

            xhr.onerror = function () {
                firmwareStepTimers.forEach(function (t) { clearTimeout(t); });
                showFirmwareStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            };

            xhr.ontimeout = function () {
                firmwareStepTimers.forEach(function (t) { clearTimeout(t); });
                showFirmwareStatus('‚ùå –¢–∞–π–º–∞—É—Ç –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            };

            xhr.timeout = 120000;
            xhr.send(formData);
        });
    </script>
</body>

</html>